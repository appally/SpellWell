<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>单词小超人 - 单词学习</title>
    <style>
        /* 导入字体 */
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One:wght@400&family=Comic+Neue:wght@400;700&display=swap');
        
        /* VDS 系统变量 */
        :root {
            --primary-color: #7FB3D3;
            --accent-color: #F4A6A6;
            --bg-color: #F8F6F0;
            --success-color: #A8D8A8;
            --warning-color: #F4D03F;
            --glow-color: #FFE5B4;
            --text-primary: #4A4A4A;
            --text-secondary: #6B6B6B;
            --text-light: #8A8A8A;
            --font-display: 'Fredoka One', cursive;
            --font-body: 'Comic Neue', 'PingFang SC', sans-serif;
        }
        
        /* 关键帧动画 */
        @keyframes jellyBounce {
            0% { transform: scale(1); }
            30% { transform: scale(1.25, 0.75); }
            40% { transform: scale(0.75, 1.25); }
            50% { transform: scale(1.15, 0.85); }
            65% { transform: scale(0.95, 1.05); }
            75% { transform: scale(1.05, 0.95); }
            100% { transform: scale(1); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-30px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes cardFlip {
            0% { transform: rotateY(0deg); }
            50% { transform: rotateY(90deg); }
            100% { transform: rotateY(0deg); }
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 8px var(--glow-color); }
            50% { box-shadow: 0 0 20px var(--glow-color), 0 0 30px var(--glow-color); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes progressFill {
            from { width: 0%; }
            to { width: var(--progress-width); }
        }
        
        @keyframes correctFeedback {
            0% { background: var(--success-color); transform: scale(1); }
            50% { background: #90EE90; transform: scale(1.05); }
            100% { background: var(--success-color); transform: scale(1); }
        }
        
        @keyframes incorrectFeedback {
            0% { background: #FF6B6B; transform: translateX(0); }
            25% { background: #FF4757; transform: translateX(-5px); }
            75% { background: #FF4757; transform: translateX(5px); }
            100% { background: #FF6B6B; transform: translateX(0); }
        }
        
        /* 基础样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: var(--font-body);
            background: radial-gradient(circle at 20% 50%, rgba(120, 119, 108, 0.03) 0%, transparent 50%),
                       radial-gradient(circle at 80% 20%, rgba(120, 119, 108, 0.03) 0%, transparent 50%),
                       radial-gradient(circle at 40% 80%, rgba(120, 119, 108, 0.03) 0%, transparent 50%),
                       var(--bg-color);
            background-size: 100px 100px, 80px 80px, 120px 120px;
            background-position: 0 0, 40px 60px, 130px 270px;
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* 安全区适配 */
        .safe-area {
            padding: 88px 16px 34px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* 顶部HUD */
        .top-hud {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            animation: fadeIn 0.8s ease-out;
        }
        
        .level-info {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255, 255, 255, 0.8);
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(74, 74, 74, 0.1);
        }
        
        .level-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary-color), #A8C8E1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        
        .level-details {
            display: flex;
            flex-direction: column;
        }
        
        .level-title {
            font-size: 14px;
            font-weight: bold;
            color: var(--text-primary);
        }
        
        .level-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .close-btn {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 4px 12px rgba(74, 74, 74, 0.1);
        }
        
        .close-btn:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.9);
        }
        
        .close-btn:active {
            animation: jellyBounce 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        /* 进度条 */
        .progress-container {
            margin-bottom: 24px;
            animation: slideInUp 1s ease-out;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .progress-text {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .progress-number {
            font-size: 14px;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(127, 179, 211, 0.2);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), #A8C8E1);
            border-radius: 4px;
            transition: width 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            position: relative;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* 手写默写区域 */
        .dictation-area {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 24px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 8px 24px rgba(74, 74, 74, 0.1),
                       inset 0 1px 0 rgba(255,255,255,0.5);
            animation: slideInUp 0.8s ease-out;
            position: relative;
            overflow: hidden;
        }
        
        .dictation-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-color), var(--primary-color));
        }
        
        .dictation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .dictation-title {
            font-family: var(--font-display);
            font-size: 20px;
            color: var(--primary-color);
        }
        
        .word-hint {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(127, 179, 211, 0.1);
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .target-word-display {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .word-meaning {
            font-size: 24px;
            color: var(--text-primary);
            margin-bottom: 12px;
            font-weight: bold;
        }
        
        .word-phonetic {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 16px;
            font-style: italic;
        }
        
        .pronunciation-btn {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--accent-color), #F7C4C4);
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            margin: 0 auto 20px;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 4px 12px rgba(244, 166, 166, 0.3);
        }
        
        .pronunciation-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(244, 166, 166, 0.4);
        }
        
        .pronunciation-btn:active {
            animation: jellyBounce 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        .pronunciation-btn.playing {
            animation: pulse 1s ease-in-out infinite;
        }
        
        /* 手写画布区域 */
        .writing-canvas-container {
            position: relative;
            background: #FFFFFF;
            border: 2px dashed var(--primary-color);
            border-radius: 16px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .writing-canvas {
            display: block;
            width: 100%;
            height: 200px;
            cursor: crosshair;
            touch-action: none;
        }
        
        .canvas-guide-lines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0.3;
        }
        
        .guide-line {
            stroke: var(--primary-color);
            stroke-width: 1;
            stroke-dasharray: 5 5;
        }
        
        .writing-hint-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .writing-hint-overlay.show {
            opacity: 0.3;
        }
        
        .hint-text {
            font-family: 'Times New Roman', serif;
            font-size: 40px;
            fill: var(--primary-color);
            stroke: var(--primary-color);
            stroke-width: 2;
            stroke-dasharray: 200;
            stroke-dashoffset: 200;
            animation: drawingHint 3s ease-in-out infinite;
        }
        
        @keyframes drawingHint {
            0% { stroke-dashoffset: 200; }
            100% { stroke-dashoffset: 0; }
        }
        
        /* 工具栏 */
        .writing-toolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .tool-btn {
            background: rgba(127, 179, 211, 0.1);
            border: 2px solid var(--primary-color);
            border-radius: 12px;
            padding: 6px 10px;
            font-size: 12px;
            color: var(--primary-color);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            min-height: 32px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .tool-btn.active {
            background: var(--primary-color);
            color: white;
        }
        
        .tool-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(127, 179, 211, 0.2);
        }
        
        .tool-btn:active {
            animation: jellyBounce 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        /* 识别结果显示 */
        .recognition-result {
            background: rgba(168, 216, 168, 0.1);
            border: 2px solid var(--success-color);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 16px;
            text-align: center;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .recognition-result.empty {
            background: rgba(127, 179, 211, 0.1);
            border-color: var(--primary-color);
            color: var(--text-light);
        }
        
        .recognition-result.correct {
            background: rgba(168, 216, 168, 0.2);
            border-color: var(--success-color);
            color: var(--success-color);
            animation: correctShake 0.5s ease-out;
        }
        
        .recognition-result.incorrect {
            background: rgba(255, 107, 107, 0.1);
            border-color: #FF6B6B;
            color: #FF6B6B;
            animation: correctShake 0.5s ease-out;
        }
        
        @keyframes correctShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .result-text {
            font-size: 16px;
            font-weight: bold;
        }
        
        .confidence-score {
            font-size: 12px;
            margin-left: 8px;
            opacity: 0.7;
        }
        
        /* 操作按钮 */
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            animation: slideInUp 1.2s ease-out;
        }
        
        .action-btn {
            flex: 1;
            border: none;
            border-radius: 20px;
            padding: 16px 20px;
            font-size: 16px;
            font-weight: bold;
            font-family: var(--font-body);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            min-height: 56px;
            box-shadow: 0 4px 12px rgba(74, 74, 74, 0.1),
                       inset 0 1px 0 rgba(255,255,255,0.3);
            position: relative;
            overflow: hidden;
        }
        
        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .action-btn:hover::before {
            left: 100%;
        }
        
        .action-btn.start-dictation {
            background: linear-gradient(135deg, var(--primary-color), #A8C8E1);
            color: white;
        }
        
        .action-btn.clear-canvas {
            background: linear-gradient(135deg, var(--warning-color), #F7DC6F);
            color: var(--text-primary);
        }
        
        .action-btn.show-hint {
            background: linear-gradient(135deg, var(--accent-color), #F7C4C4);
            color: var(--text-primary);
        }
        
        .action-btn.check-answer {
            background: linear-gradient(135deg, var(--success-color), #C8E6C8);
            color: var(--text-primary);
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(74, 74, 74, 0.15);
        }
        
        .action-btn:active {
            transform: scale(0.95);
            animation: jellyBounce 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* 反馈覆盖层 */
        .feedback-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .feedback-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }
        
        .feedback-card {
            background: var(--bg-color);
            border-radius: 24px;
            padding: 32px 24px;
            max-width: 320px;
            width: 90%;
            text-align: center;
            box-shadow: 0 12px 32px rgba(74, 74, 74, 0.2);
            transform: scale(0.8);
            transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        .feedback-overlay.show .feedback-card {
            transform: scale(1);
        }
        
        .feedback-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }
        
        .feedback-icon.correct {
            background: linear-gradient(135deg, var(--success-color), #C8E6C8);
            animation: correctFeedback 0.6s ease-out;
        }
        
        .feedback-icon.incorrect {
            background: linear-gradient(135deg, #FF6B6B, #FF4757);
            animation: incorrectFeedback 0.6s ease-out;
        }
        
        .feedback-title {
            font-family: var(--font-display);
            font-size: 24px;
            margin-bottom: 12px;
        }
        
        .feedback-title.correct {
            color: var(--success-color);
        }
        
        .feedback-title.incorrect {
            color: #FF6B6B;
        }
        
        .feedback-desc {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 24px;
            line-height: 1.4;
        }
        
        .feedback-btn {
            width: 100%;
            border: none;
            border-radius: 16px;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: bold;
            font-family: var(--font-body);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            min-height: 48px;
            background: linear-gradient(135deg, var(--primary-color), #A8C8E1);
            color: white;
        }
        
        /* 统计信息 */
        .stats-container {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            animation: slideInLeft 1s ease-out;
        }
        
        .stat-item {
            flex: 1;
            background: rgba(255, 255, 255, 0.8);
            padding: 12px 8px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(74, 74, 74, 0.1);
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        
        /* 响应式设计 */
        @media (max-width: 480px) {
            .word-main {
                font-size: 28px;
            }
            
            .word-phonetic {
                font-size: 16px;
            }
            
            .word-meaning {
                font-size: 18px;
            }
            
            .word-example {
                font-size: 14px;
            }
            
            .action-btn {
                font-size: 14px;
                padding: 12px 16px;
                min-height: 48px;
            }
        }
    </style>
</head>
<body>
    <div class="safe-area">
        <!-- 顶部HUD -->
        <div class="top-hud">
            <div class="level-info">
                <div class="level-icon" id="levelIcon">📖</div>
                <div class="level-details">
                    <div class="level-title" id="levelTitle">第1关 - 基础词汇</div>
                    <div class="level-subtitle" id="levelSubtitle">学习模式</div>
                </div>
            </div>
            
            <button class="close-btn" onclick="exitLearning()">
                ✕
            </button>
        </div>
        
        <!-- 进度条 -->
        <div class="progress-container">
            <div class="progress-header">
                <span class="progress-text">学习进度</span>
                <span class="progress-number" id="progressNumber">1/5</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 20%;"></div>
            </div>
        </div>
        
        <!-- 统计信息 -->
        <div class="stats-container">
            <div class="stat-item">
                <div class="stat-value" id="correctCount">0</div>
                <div class="stat-label">正确</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="streakCount">0</div>
                <div class="stat-label">连击</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="accuracyRate">0%</div>
                <div class="stat-label">准确率</div>
            </div>
        </div>
        
        <!-- 手写默写区域 -->
        <div class="dictation-area" id="dictationArea">
            <div class="dictation-header">
                <div class="dictation-title">✏️ 手写默写</div>
                <div class="word-hint">
                    <span>💡</span>
                    <span>听音写词</span>
                </div>
            </div>
            
            <div class="target-word-display">
                <div class="word-meaning" id="wordMeaning">苹果</div>
                <div class="word-phonetic" id="wordPhonetic">/ˈæpəl/</div>
                
                <button class="pronunciation-btn" id="pronunciationBtn" onclick="playPronunciation()">
                    🔊
                </button>
            </div>
            
            <!-- 手写工具栏 -->
            <div class="writing-toolbar">
                <button class="tool-btn active" id="penTool" onclick="selectTool('pen')">
                    ✏️ 画笔
                </button>
                <button class="tool-btn" id="eraserTool" onclick="selectTool('eraser')">
                    🧹 橡皮
                </button>
                <button class="tool-btn" onclick="undoStroke()">
                    ↶ 撤销
                </button>
                <button class="tool-btn" onclick="redoStroke()">
                    ↷ 重做
                </button>
            </div>
            
            <!-- 手写画布 -->
            <div class="writing-canvas-container">
                <canvas class="writing-canvas" id="writingCanvas"></canvas>
                
                <!-- 引导线 -->
                <svg class="canvas-guide-lines">
                    <line class="guide-line" x1="0" y1="50%" x2="100%" y2="50%"></line>
                    <line class="guide-line" x1="0" y1="25%" x2="100%" y2="25%"></line>
                    <line class="guide-line" x1="0" y1="75%" x2="100%" y2="75%"></line>
                </svg>
                
                <!-- 提示覆盖层 -->
                <svg class="writing-hint-overlay" id="hintOverlay">
                    <text class="hint-text" id="hintText" x="50%" y="60%" text-anchor="middle">Apple</text>
                </svg>
            </div>
            
            <!-- 识别结果 -->
            <div class="recognition-result empty" id="recognitionResult">
                <span class="result-text">开始书写...</span>
            </div>
        </div>
        
        <!-- 操作按钮 -->
        <div class="action-buttons">
            <button class="action-btn clear-canvas" onclick="clearCanvas()">🗑️ 清除</button>
            <button class="action-btn show-hint" onclick="toggleHint()">💡 提示</button>
            <button class="action-btn check-answer" onclick="checkAnswer()">✅ 检查</button>
        </div>
    </div>
    
    <!-- 反馈覆盖层 -->
    <div class="feedback-overlay" id="feedbackOverlay">
        <div class="feedback-card">
            <div class="feedback-icon" id="feedbackIcon">✅</div>
            <div class="feedback-title" id="feedbackTitle">太棒了！</div>
            <div class="feedback-desc" id="feedbackDesc">你已经掌握了这个单词</div>
            <button class="feedback-btn" onclick="nextWord()">继续学习</button>
        </div>
    </div>
    
    <script>
        // VDS 核心工具集
        const VDS = {
            colors: {
                primary: '#7FB3D3',
                accent: '#F4A6A6',
                bg: '#F8F6F0',
                success: '#A8D8A8',
                warning: '#F4D03F',
                glow: '#FFE5B4'
            },
            animations: {
                easing: 'cubic-bezier(0.68, -0.55, 0.265, 1.55)',
                duration: {
                    fast: 0.15,
                    normal: 0.3,
                    slow: 0.6
                }
            }
        };
        
        // 场景管理器
        function goToScene(sceneFile) {
            document.body.style.transition = 'opacity 0.3s ease-in-out';
            document.body.style.opacity = '0';
            setTimeout(() => {
                window.location.href = sceneFile;
            }, 300);
        }
        
        // 音效模拟
        function playSound(type) {
            console.log(`🔊 播放音效: ${type}`);
        }
        
        // 手写默写控制器
        class HandwritingController {
            constructor() {
                this.currentLevel = 1;
                this.currentWordIndex = 0;
                this.words = [];
                this.canvas = null;
                this.ctx = null;
                this.isDrawing = false;
                this.currentTool = 'pen';
                this.brushSize = 3;
                this.strokes = [];
                this.currentStroke = [];
                this.undoStack = [];
                this.redoStack = [];
                this.showingHint = false;
                this.stats = {
                    correct: 0,
                    total: 0,
                    streak: 0,
                    maxStreak: 0
                };
                this.levelData = null;
                this.init();
            }
            
            init() {
                this.loadLevelData();
                this.generateWords();
                this.setupCanvas();
                this.updateUI();
                this.showCurrentWord();
                this.bindEvents();
                this.showPageAnimation();
            }
            
            loadLevelData() {
                // 从localStorage获取当前关卡
                const savedLevel = localStorage.getItem('wordHero_currentLevel');
                if (savedLevel) {
                    this.currentLevel = parseInt(savedLevel);
                }
                
                // 模拟关卡数据
                const levelNames = [
                    '基础词汇', '动物世界', '颜色彩虹', '数字游戏', '家庭成员',
                    '学校生活', '食物天地', '交通工具', '身体部位', '天气变化'
                ];
                
                this.levelData = {
                    id: this.currentLevel,
                    name: levelNames[this.currentLevel - 1] || '词汇学习',
                    icon: '✏️',
                    totalWords: 5
                };
            }
            
            generateWords() {
                // 根据关卡生成单词数据
                const wordSets = {
                    1: [ // 基础词汇
                        {
                            word: 'Apple',
                            phonetic: '/ˈæpəl/',
                            meaning: '苹果'
                        },
                        {
                            word: 'Book',
                            phonetic: '/bʊk/',
                            meaning: '书'
                        },
                        {
                            word: 'Cat',
                            phonetic: '/kæt/',
                            meaning: '猫'
                        },
                        {
                            word: 'Dog',
                            phonetic: '/dɔːɡ/',
                            meaning: '狗'
                        },
                        {
                            word: 'House',
                            phonetic: '/haʊs/',
                            meaning: '房子'
                        }
                    ],
                    2: [ // 动物世界
                        {
                            word: 'Elephant',
                            phonetic: '/ˈelɪfənt/',
                            meaning: '大象'
                        },
                        {
                            word: 'Lion',
                            phonetic: '/ˈlaɪən/',
                            meaning: '狮子'
                        },
                        {
                            word: 'Tiger',
                            phonetic: '/ˈtaɪɡər/',
                            meaning: '老虎'
                        },
                        {
                            word: 'Monkey',
                            phonetic: '/ˈmʌŋki/',
                            meaning: '猴子'
                        },
                        {
                            word: 'Bird',
                            phonetic: '/bɜːrd/',
                            meaning: '鸟'
                        }
                    ]
                };
                
                this.words = wordSets[this.currentLevel] || wordSets[1];
                this.levelData.totalWords = this.words.length;
            }
            
            setupCanvas() {
                this.canvas = document.getElementById('writingCanvas');
                this.ctx = this.canvas.getContext('2d');
                
                // 设置画布尺寸
                const container = this.canvas.parentElement;
                this.canvas.width = container.offsetWidth;
                this.canvas.height = 200;
                
                // 设置画布样式
                this.ctx.lineCap = 'round';
                this.ctx.lineJoin = 'round';
                this.ctx.strokeStyle = '#2C3E50';
                this.ctx.lineWidth = this.brushSize;
            }
            
            updateUI() {
                // 更新关卡信息
                document.getElementById('levelIcon').textContent = this.levelData.icon;
                document.getElementById('levelTitle').textContent = `第${this.levelData.id}关 - ${this.levelData.name}`;
                
                // 更新进度
                this.updateProgress();
                
                // 更新统计
                this.updateStats();
            }
            
            updateProgress() {
                const progress = ((this.currentWordIndex + 1) / this.levelData.totalWords) * 100;
                document.getElementById('progressNumber').textContent = `${this.currentWordIndex + 1}/${this.levelData.totalWords}`;
                document.getElementById('progressFill').style.width = progress + '%';
            }
            
            updateStats() {
                document.getElementById('correctCount').textContent = this.stats.correct;
                document.getElementById('streakCount').textContent = this.stats.streak;
                
                const accuracy = this.stats.total > 0 ? Math.round((this.stats.correct / this.stats.total) * 100) : 0;
                document.getElementById('accuracyRate').textContent = accuracy + '%';
            }
            
            showCurrentWord() {
                if (this.currentWordIndex >= this.words.length) {
                    this.completeLearning();
                    return;
                }
                
                const word = this.words[this.currentWordIndex];
                
                // 更新单词显示
                document.getElementById('wordMeaning').textContent = word.meaning;
                document.getElementById('wordPhonetic').textContent = word.phonetic;
                document.getElementById('hintText').textContent = word.word;
                
                // 重置画布和提示
                this.clearCanvas();
                this.hideHint();
                
                this.updateProgress();
            }
            
            bindEvents() {
                // 画布事件
                this.canvas.addEventListener('mousedown', this.startDrawing.bind(this));
                this.canvas.addEventListener('mousemove', this.draw.bind(this));
                this.canvas.addEventListener('mouseup', this.stopDrawing.bind(this));
                this.canvas.addEventListener('mouseout', this.stopDrawing.bind(this));
                
                // 触摸事件
                this.canvas.addEventListener('touchstart', this.handleTouch.bind(this));
                this.canvas.addEventListener('touchmove', this.handleTouch.bind(this));
                this.canvas.addEventListener('touchend', this.stopDrawing.bind(this));
                
                // 键盘快捷键
                document.addEventListener('keydown', (e) => {
                    if (e.key === '1') this.clearCanvas();
                    if (e.key === '2') this.toggleHint();
                    if (e.key === '3') this.checkAnswer();
                    if (e.key === ' ') {
                        e.preventDefault();
                        playPronunciation();
                    }
                    if (e.ctrlKey && e.key === 'z') {
                        e.preventDefault();
                        this.undoStroke();
                    }
                    if (e.ctrlKey && e.key === 'y') {
                        e.preventDefault();
                        this.redoStroke();
                    }
                    if (e.key === 'Escape') {
                        exitLearning();
                    }
                });
            }
            
            startDrawing(e) {
                this.isDrawing = true;
                this.currentStroke = [];
                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                this.ctx.beginPath();
                this.ctx.moveTo(x, y);
                this.currentStroke.push({ x, y });
            }
            
            draw(e) {
                if (!this.isDrawing) return;
                
                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                if (this.currentTool === 'pen') {
                    this.ctx.globalCompositeOperation = 'source-over';
                    this.ctx.strokeStyle = '#2C3E50';
                } else if (this.currentTool === 'eraser') {
                    this.ctx.globalCompositeOperation = 'destination-out';
                }
                
                this.ctx.lineTo(x, y);
                this.ctx.stroke();
                this.currentStroke.push({ x, y });
                
                // 实时识别
                this.recognizeWriting();
            }
            
            stopDrawing() {
                if (!this.isDrawing) return;
                this.isDrawing = false;
                
                if (this.currentStroke.length > 0) {
                    this.strokes.push([...this.currentStroke]);
                    this.undoStack.push([...this.strokes]);
                    this.redoStack = [];
                }
            }
            
            handleTouch(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                                 e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                this.canvas.dispatchEvent(mouseEvent);
            }
            
            recognizeWriting() {
                // 模拟手写识别
                const currentWord = this.words[this.currentWordIndex];
                const result = document.getElementById('recognitionResult');
                
                if (this.strokes.length > 0) {
                    // 简单的模拟识别逻辑
                    const confidence = Math.min(0.95, 0.3 + (this.strokes.length * 0.1));
                    const recognizedText = this.strokes.length > 2 ? currentWord.word : currentWord.word.substring(0, this.strokes.length);
                    
                    result.className = 'recognition-result';
                    result.innerHTML = `
                        <span class="result-text">${recognizedText}</span>
                        <span class="confidence-score">${Math.round(confidence * 100)}%</span>
                    `;
                } else {
                    result.className = 'recognition-result empty';
                    result.innerHTML = '<span class="result-text">开始书写...</span>';
                }
            }
            
            selectTool(tool) {
                this.currentTool = tool;
                document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById(tool + 'Tool').classList.add('active');
            }
            
            clearCanvas() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.strokes = [];
                this.currentStroke = [];
                this.undoStack = [];
                this.redoStack = [];
                this.recognizeWriting();
            }
            
            undoStroke() {
                if (this.undoStack.length > 1) {
                    this.redoStack.push(this.undoStack.pop());
                    this.strokes = [...this.undoStack[this.undoStack.length - 1]];
                    this.redrawCanvas();
                }
            }
            
            redoStroke() {
                if (this.redoStack.length > 0) {
                    this.undoStack.push(this.redoStack.pop());
                    this.strokes = [...this.undoStack[this.undoStack.length - 1]];
                    this.redrawCanvas();
                }
            }
            
            redrawCanvas() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.ctx.strokeStyle = '#2C3E50';
                this.ctx.globalCompositeOperation = 'source-over';
                
                this.strokes.forEach(stroke => {
                    if (stroke.length > 0) {
                        this.ctx.beginPath();
                        this.ctx.moveTo(stroke[0].x, stroke[0].y);
                        stroke.forEach(point => {
                            this.ctx.lineTo(point.x, point.y);
                        });
                        this.ctx.stroke();
                    }
                });
                
                this.recognizeWriting();
            }
            
            toggleHint() {
                const hintOverlay = document.getElementById('hintOverlay');
                this.showingHint = !this.showingHint;
                
                if (this.showingHint) {
                    hintOverlay.classList.add('show');
                } else {
                    hintOverlay.classList.remove('show');
                }
            }
            
            hideHint() {
                const hintOverlay = document.getElementById('hintOverlay');
                this.showingHint = false;
                hintOverlay.classList.remove('show');
            }
            
            checkAnswer() {
                const currentWord = this.words[this.currentWordIndex];
                const result = document.getElementById('recognitionResult');
                const recognizedText = result.querySelector('.result-text')?.textContent || '';
                
                if (recognizedText.toLowerCase() === currentWord.word.toLowerCase()) {
                    this.stats.correct++;
                    this.stats.total++;
                    this.stats.streak++;
                    this.stats.maxStreak = Math.max(this.stats.maxStreak, this.stats.streak);
                    
                    this.showFeedback(true, '写得很棒！', '你已经掌握了这个单词');
                } else {
                    this.stats.total++;
                    this.stats.streak = 0;
                    
                    this.showFeedback(false, '再试试看', '多练习几次就能记住了');
                }
            }
            
            showFeedback(isCorrect, title, desc) {
                const overlay = document.getElementById('feedbackOverlay');
                const icon = document.getElementById('feedbackIcon');
                const titleEl = document.getElementById('feedbackTitle');
                const descEl = document.getElementById('feedbackDesc');
                
                icon.textContent = isCorrect ? '✅' : '💪';
                icon.className = `feedback-icon ${isCorrect ? 'correct' : 'incorrect'}`;
                
                titleEl.textContent = title;
                titleEl.className = `feedback-title ${isCorrect ? 'correct' : 'incorrect'}`;
                
                descEl.textContent = desc;
                
                overlay.classList.add('show');
                
                this.updateStats();
            }
            
            nextWord() {
                document.getElementById('feedbackOverlay').classList.remove('show');
                
                this.currentWordIndex++;
                
                setTimeout(() => {
                    this.showCurrentWord();
                }, 300);
            }
            
            completeLearning() {
                // 保存学习进度
                const progress = {
                    currentLevel: this.currentLevel + 1,
                    completedLevels: [this.currentLevel],
                    stats: this.stats
                };
                
                localStorage.setItem('wordHero_progress', JSON.stringify(progress));
                
                // 显示完成反馈
                this.showFeedback(true, '关卡完成！', `准确率: ${Math.round((this.stats.correct / this.stats.total) * 100)}%`);
                
                // 延迟跳转到冒险地图
                setTimeout(() => {
                    goToScene('./V003_AdventureMap.html');
                }, 2000);
            }
            
            showPageAnimation() {
                document.body.style.opacity = '0';
                document.body.style.transition = 'opacity 0.5s ease-in-out';
                
                setTimeout(() => {
                    document.body.style.opacity = '1';
                }, 100);
            }
        }
        
        // 主要功能函数
        function playPronunciation() {
            playSound('pronunciation');
            
            const btn = document.getElementById('pronunciationBtn');
            btn.classList.add('playing');
            
            // 模拟发音时长
            setTimeout(() => {
                btn.classList.remove('playing');
            }, 1000);
        }
        
        function selectTool(tool) {
            handwritingController.selectTool(tool);
        }
        
        function clearCanvas() {
            handwritingController.clearCanvas();
        }
        
        function undoStroke() {
            handwritingController.undoStroke();
        }
        
        function redoStroke() {
            handwritingController.redoStroke();
        }
        
        function toggleHint() {
            handwritingController.toggleHint();
        }
        
        function checkAnswer() {
            handwritingController.checkAnswer();
        }
        
        function nextWord() {
            handwritingController.nextWord();
        }
        
        function exitLearning() {
            playSound('button_click');
            
            if (confirm('确定要退出手写练习吗？进度将会保存。')) {
                goToScene('./V003_AdventureMap.html');
            }
        }
        
        // 初始化
        let handwritingController;
        
        document.addEventListener('DOMContentLoaded', function() {
            handwritingController = new HandwritingController();
        });
    </script>
</body>
</html>