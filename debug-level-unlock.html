<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>关卡解锁调试工具</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056CC;
        }
        .log {
            background: #f8f8f8;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        input, select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 关卡解锁调试工具</h1>
        
        <div class="section">
            <h3>📊 当前用户状态</h3>
            <div id="userStatus" class="status info">加载中...</div>
            <button onclick="loadUserProfile()">刷新用户状态</button>
            <button onclick="resetUserProfile()">重置用户档案</button>
        </div>
        
        <div class="section">
            <h3>🎮 模拟关卡完成</h3>
            <label>关卡编号: 
                <input type="number" id="levelInput" value="1" min="1" max="20">
            </label>
            <label>正确单词数: 
                <input type="number" id="correctInput" value="5" min="0">
            </label>
            <label>总单词数: 
                <input type="number" id="totalInput" value="5" min="1">
            </label>
            <br>
            <button onclick="simulateLevelCompletion()">模拟完成关卡</button>
            <button onclick="unlockSpecificLevel()">直接解锁下一关</button>
        </div>
        
        <div class="section">
            <h3>🔍 关卡状态检查</h3>
            <button onclick="checkAllLevels()">检查所有关卡状态</button>
            <button onclick="checkLevelData()">检查关卡数据结构</button>
        </div>
        
        <div class="section">
            <h3>📝 调试日志</h3>
            <button onclick="clearLog()">清空日志</button>
            <div id="debugLog" class="log">等待操作...</div>
        </div>
    </div>

    <script>
        // 模拟小程序环境
        const wx = {
            getStorageSync: function(key) {
                return JSON.parse(localStorage.getItem(key) || 'null');
            },
            setStorageSync: function(key, data) {
                localStorage.setItem(key, JSON.stringify(data));
            },
            removeStorageSync: function(key) {
                localStorage.removeItem(key);
            }
        };
        
        // 模拟require函数
        function require(path) {
            if (path.includes('util')) {
                return {
                    storage: {
                        get: wx.getStorageSync,
                        set: wx.setStorageSync,
                        remove: wx.removeStorageSync
                    }
                };
            }
            return {};
        }
        
        // 简化的数据管理器
        class DebugDataManager {
            constructor() {
                this.storageKeys = {
                    userProfile: 'wordHero_profile',
                    backup: 'wordHero_profile_backup'
                };
            }
            
            getUserProfile() {
                try {
                    const profile = wx.getStorageSync(this.storageKeys.userProfile);
                    if (!profile) {
                        return this.createDefaultProfile();
                    }
                    return profile;
                } catch (error) {
                    log('获取用户档案失败: ' + error.message, 'error');
                    return this.createDefaultProfile();
                }
            }
            
            createDefaultProfile() {
                const defaultProfile = {
                    userId: 'debug_user_' + Date.now(),
                    version: '2.0',
                    createdAt: new Date().toISOString(),
                    lastUpdated: new Date().toISOString(),
                    
                    // 基本信息
                    nickname: '调试用户',
                    avatar: '🔧',
                    grade: 'primary',
                    currentLevel: 1,
                    totalWordsLearned: 0,
                    streak: 0,
                    lastStudyDate: null,
                    
                    // 详细学习进度
                    progress: {
                        currentLevel: 1,
                        completedLevels: [],
                        levelProgress: {},
                        totalScore: 0,
                        globalStreak: 0,
                        maxStreak: 0
                    }
                };
                
                this.saveUserProfile(defaultProfile);
                return defaultProfile;
            }
            
            saveUserProfile(profile) {
                try {
                    // 备份当前数据
                    const currentProfile = wx.getStorageSync(this.storageKeys.userProfile);
                    if (currentProfile) {
                        wx.setStorageSync(this.storageKeys.backup, currentProfile);
                    }
                    
                    // 更新时间戳
                    profile.lastUpdated = new Date().toISOString();
                    
                    // 保存数据
                    wx.setStorageSync(this.storageKeys.userProfile, profile);
                    
                    log('用户档案保存成功', 'success');
                    return profile;
                } catch (error) {
                    log('保存用户档案失败: ' + error.message, 'error');
                    throw error;
                }
            }
            
            async completeLevelProgress(levelId, stats) {
                try {
                    log(`开始记录关卡${levelId}完成...`, 'info');
                    
                    const levelKey = `level_complete_${levelId}`;
                    const levelData = {
                        levelId,
                        accuracy: stats.accuracy,
                        totalWords: stats.totalWords,
                        correctWords: stats.correctWords,
                        sessionId: stats.sessionId || 'debug_session',
                        completedAt: new Date().toISOString()
                    };
                    
                    wx.setStorageSync(levelKey, levelData);
                    log(`关卡${levelId}完成数据已保存`, 'success');
                    
                    // 解锁下一关
                    await this.unlockNextLevel(levelId);
                    
                    log(`🎉 完成关卡 ${levelId}: ${stats.correctWords}/${stats.totalWords} 正确`, 'success');
                    return true;
                } catch (error) {
                    log('记录关卡完成失败: ' + error.message, 'error');
                    return false;
                }
            }
            
            async unlockNextLevel(currentLevel) {
                try {
                    log(`开始解锁关卡${currentLevel + 1}...`, 'info');
                    
                    const userProfile = this.getUserProfile();
                    log(`当前用户档案: currentLevel=${userProfile.currentLevel}, progress.currentLevel=${userProfile.progress.currentLevel}`, 'info');
                    log(`已完成关卡: [${userProfile.progress.completedLevels.join(', ')}]`, 'info');
                    
                    if (userProfile && currentLevel >= userProfile.currentLevel) {
                        // 同时更新两个位置的currentLevel以确保兼容性
                        const oldCurrentLevel = userProfile.currentLevel;
                        userProfile.currentLevel = currentLevel + 1;
                        userProfile.progress.currentLevel = currentLevel + 1;
                        
                        log(`更新currentLevel: ${oldCurrentLevel} -> ${currentLevel + 1}`, 'info');
                        
                        // 标记当前关卡为已完成
                        if (!userProfile.progress.completedLevels.includes(currentLevel)) {
                            userProfile.progress.completedLevels.push(currentLevel);
                            log(`添加已完成关卡: ${currentLevel}`, 'info');
                        } else {
                            log(`关卡${currentLevel}已在完成列表中`, 'info');
                        }
                        
                        // 保存档案
                        await this.saveUserProfile(userProfile);
                        
                        log(`🔓 解锁关卡 ${currentLevel + 1}，已完成关卡: [${userProfile.progress.completedLevels.join(', ')}]`, 'success');
                    } else {
                        log(`跳过解锁: currentLevel=${currentLevel}, userProfile.currentLevel=${userProfile.currentLevel}`, 'info');
                    }
                } catch (error) {
                    log('解锁下一关失败: ' + error.message, 'error');
                }
            }
        }
        
        const dataManager = new DebugDataManager();
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('debugLog');
            const prefix = type === 'error' ? '❌' : type === 'success' ? '✅' : 'ℹ️';
            logElement.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('debugLog').textContent = '日志已清空\n';
        }
        
        function loadUserProfile() {
            try {
                const profile = dataManager.getUserProfile();
                const statusDiv = document.getElementById('userStatus');
                
                statusDiv.innerHTML = `
                    <strong>用户ID:</strong> ${profile.userId}<br>
                    <strong>当前关卡:</strong> ${profile.currentLevel}<br>
                    <strong>进度关卡:</strong> ${profile.progress.currentLevel}<br>
                    <strong>已完成关卡:</strong> [${profile.progress.completedLevels.join(', ')}]<br>
                    <strong>最后更新:</strong> ${profile.lastUpdated}
                `;
                
                log('用户档案加载完成', 'success');
            } catch (error) {
                log('加载用户档案失败: ' + error.message, 'error');
            }
        }
        
        function resetUserProfile() {
            try {
                wx.removeStorageSync('wordHero_profile');
                wx.removeStorageSync('wordHero_profile_backup');
                
                // 清除所有关卡完成记录
                for (let i = 1; i <= 20; i++) {
                    wx.removeStorageSync(`level_complete_${i}`);
                }
                
                log('用户档案已重置', 'success');
                loadUserProfile();
            } catch (error) {
                log('重置用户档案失败: ' + error.message, 'error');
            }
        }
        
        async function simulateLevelCompletion() {
            const levelId = parseInt(document.getElementById('levelInput').value);
            const correct = parseInt(document.getElementById('correctInput').value);
            const total = parseInt(document.getElementById('totalInput').value);
            
            if (levelId < 1 || levelId > 20) {
                log('关卡编号必须在1-20之间', 'error');
                return;
            }
            
            if (correct > total) {
                log('正确数量不能大于总数量', 'error');
                return;
            }
            
            const accuracy = total > 0 ? (correct / total * 100) : 0;
            
            log(`开始模拟关卡${levelId}完成: ${correct}/${total} (${accuracy.toFixed(1)}%)`, 'info');
            
            try {
                const result = await dataManager.completeLevelProgress(levelId, {
                    accuracy,
                    totalWords: total,
                    correctWords: correct,
                    sessionId: 'debug_session_' + Date.now()
                });
                
                if (result) {
                    log('关卡完成模拟成功', 'success');
                    loadUserProfile();
                } else {
                    log('关卡完成模拟失败', 'error');
                }
            } catch (error) {
                log('模拟关卡完成时出错: ' + error.message, 'error');
            }
        }
        
        async function unlockSpecificLevel() {
            const levelId = parseInt(document.getElementById('levelInput').value);
            
            if (levelId < 1 || levelId > 19) {
                log('关卡编号必须在1-19之间', 'error');
                return;
            }
            
            log(`直接解锁关卡${levelId + 1}...`, 'info');
            
            try {
                await dataManager.unlockNextLevel(levelId);
                loadUserProfile();
            } catch (error) {
                log('直接解锁失败: ' + error.message, 'error');
            }
        }
        
        function checkAllLevels() {
            log('检查所有关卡状态...', 'info');
            
            const profile = dataManager.getUserProfile();
            
            for (let i = 1; i <= 20; i++) {
                const completedLevels = profile.progress.completedLevels;
                const currentLevel = profile.progress.currentLevel;
                
                let status = 'locked';
                if (completedLevels.includes(i)) {
                    status = 'completed';
                } else if (i === currentLevel) {
                    status = 'current';
                } else if (i <= currentLevel) {
                    status = 'available';
                }
                
                log(`关卡${i}: ${status}`, 'info');
            }
        }
        
        function checkLevelData() {
            log('检查关卡数据结构...', 'info');
            
            // 模拟关卡数据
            const mockLevelData = {
                level: 1,
                id: 1,
                theme: '测试主题',
                name: '第1关',
                words: [
                    { word: 'test', chinese: '测试' }
                ],
                totalWords: 1
            };
            
            log('模拟关卡数据:', 'info');
            log(JSON.stringify(mockLevelData, null, 2), 'info');
            
            // 检查属性访问
            log(`levelData.level = ${mockLevelData.level}`, 'info');
            log(`levelData.id = ${mockLevelData.id}`, 'info');
        }
        
        // 页面加载时初始化
        window.onload = function() {
            log('调试工具初始化完成', 'success');
            loadUserProfile();
        };
    </script>
</body>
</html>