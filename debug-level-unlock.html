<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…³å¡è§£é”è°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056CC;
        }
        .log {
            background: #f8f8f8;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        input, select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ å…³å¡è§£é”è°ƒè¯•å·¥å…·</h1>
        
        <div class="section">
            <h3>ğŸ“Š å½“å‰ç”¨æˆ·çŠ¶æ€</h3>
            <div id="userStatus" class="status info">åŠ è½½ä¸­...</div>
            <button onclick="loadUserProfile()">åˆ·æ–°ç”¨æˆ·çŠ¶æ€</button>
            <button onclick="resetUserProfile()">é‡ç½®ç”¨æˆ·æ¡£æ¡ˆ</button>
        </div>
        
        <div class="section">
            <h3>ğŸ® æ¨¡æ‹Ÿå…³å¡å®Œæˆ</h3>
            <label>å…³å¡ç¼–å·: 
                <input type="number" id="levelInput" value="1" min="1" max="20">
            </label>
            <label>æ­£ç¡®å•è¯æ•°: 
                <input type="number" id="correctInput" value="5" min="0">
            </label>
            <label>æ€»å•è¯æ•°: 
                <input type="number" id="totalInput" value="5" min="1">
            </label>
            <br>
            <button onclick="simulateLevelCompletion()">æ¨¡æ‹Ÿå®Œæˆå…³å¡</button>
            <button onclick="unlockSpecificLevel()">ç›´æ¥è§£é”ä¸‹ä¸€å…³</button>
        </div>
        
        <div class="section">
            <h3>ğŸ” å…³å¡çŠ¶æ€æ£€æŸ¥</h3>
            <button onclick="checkAllLevels()">æ£€æŸ¥æ‰€æœ‰å…³å¡çŠ¶æ€</button>
            <button onclick="checkLevelData()">æ£€æŸ¥å…³å¡æ•°æ®ç»“æ„</button>
        </div>
        
        <div class="section">
            <h3>ğŸ“ è°ƒè¯•æ—¥å¿—</h3>
            <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
            <div id="debugLog" class="log">ç­‰å¾…æ“ä½œ...</div>
        </div>
    </div>

    <script>
        // æ¨¡æ‹Ÿå°ç¨‹åºç¯å¢ƒ
        const wx = {
            getStorageSync: function(key) {
                return JSON.parse(localStorage.getItem(key) || 'null');
            },
            setStorageSync: function(key, data) {
                localStorage.setItem(key, JSON.stringify(data));
            },
            removeStorageSync: function(key) {
                localStorage.removeItem(key);
            }
        };
        
        // æ¨¡æ‹Ÿrequireå‡½æ•°
        function require(path) {
            if (path.includes('util')) {
                return {
                    storage: {
                        get: wx.getStorageSync,
                        set: wx.setStorageSync,
                        remove: wx.removeStorageSync
                    }
                };
            }
            return {};
        }
        
        // ç®€åŒ–çš„æ•°æ®ç®¡ç†å™¨
        class DebugDataManager {
            constructor() {
                this.storageKeys = {
                    userProfile: 'wordHero_profile',
                    backup: 'wordHero_profile_backup'
                };
            }
            
            getUserProfile() {
                try {
                    const profile = wx.getStorageSync(this.storageKeys.userProfile);
                    if (!profile) {
                        return this.createDefaultProfile();
                    }
                    return profile;
                } catch (error) {
                    log('è·å–ç”¨æˆ·æ¡£æ¡ˆå¤±è´¥: ' + error.message, 'error');
                    return this.createDefaultProfile();
                }
            }
            
            createDefaultProfile() {
                const defaultProfile = {
                    userId: 'debug_user_' + Date.now(),
                    version: '2.0',
                    createdAt: new Date().toISOString(),
                    lastUpdated: new Date().toISOString(),
                    
                    // åŸºæœ¬ä¿¡æ¯
                    nickname: 'è°ƒè¯•ç”¨æˆ·',
                    avatar: 'ğŸ”§',
                    grade: 'primary',
                    currentLevel: 1,
                    totalWordsLearned: 0,
                    streak: 0,
                    lastStudyDate: null,
                    
                    // è¯¦ç»†å­¦ä¹ è¿›åº¦
                    progress: {
                        currentLevel: 1,
                        completedLevels: [],
                        levelProgress: {},
                        totalScore: 0,
                        globalStreak: 0,
                        maxStreak: 0
                    }
                };
                
                this.saveUserProfile(defaultProfile);
                return defaultProfile;
            }
            
            saveUserProfile(profile) {
                try {
                    // å¤‡ä»½å½“å‰æ•°æ®
                    const currentProfile = wx.getStorageSync(this.storageKeys.userProfile);
                    if (currentProfile) {
                        wx.setStorageSync(this.storageKeys.backup, currentProfile);
                    }
                    
                    // æ›´æ–°æ—¶é—´æˆ³
                    profile.lastUpdated = new Date().toISOString();
                    
                    // ä¿å­˜æ•°æ®
                    wx.setStorageSync(this.storageKeys.userProfile, profile);
                    
                    log('ç”¨æˆ·æ¡£æ¡ˆä¿å­˜æˆåŠŸ', 'success');
                    return profile;
                } catch (error) {
                    log('ä¿å­˜ç”¨æˆ·æ¡£æ¡ˆå¤±è´¥: ' + error.message, 'error');
                    throw error;
                }
            }
            
            async completeLevelProgress(levelId, stats) {
                try {
                    log(`å¼€å§‹è®°å½•å…³å¡${levelId}å®Œæˆ...`, 'info');
                    
                    const levelKey = `level_complete_${levelId}`;
                    const levelData = {
                        levelId,
                        accuracy: stats.accuracy,
                        totalWords: stats.totalWords,
                        correctWords: stats.correctWords,
                        sessionId: stats.sessionId || 'debug_session',
                        completedAt: new Date().toISOString()
                    };
                    
                    wx.setStorageSync(levelKey, levelData);
                    log(`å…³å¡${levelId}å®Œæˆæ•°æ®å·²ä¿å­˜`, 'success');
                    
                    // è§£é”ä¸‹ä¸€å…³
                    await this.unlockNextLevel(levelId);
                    
                    log(`ğŸ‰ å®Œæˆå…³å¡ ${levelId}: ${stats.correctWords}/${stats.totalWords} æ­£ç¡®`, 'success');
                    return true;
                } catch (error) {
                    log('è®°å½•å…³å¡å®Œæˆå¤±è´¥: ' + error.message, 'error');
                    return false;
                }
            }
            
            async unlockNextLevel(currentLevel) {
                try {
                    log(`å¼€å§‹è§£é”å…³å¡${currentLevel + 1}...`, 'info');
                    
                    const userProfile = this.getUserProfile();
                    log(`å½“å‰ç”¨æˆ·æ¡£æ¡ˆ: currentLevel=${userProfile.currentLevel}, progress.currentLevel=${userProfile.progress.currentLevel}`, 'info');
                    log(`å·²å®Œæˆå…³å¡: [${userProfile.progress.completedLevels.join(', ')}]`, 'info');
                    
                    if (userProfile && currentLevel >= userProfile.currentLevel) {
                        // åŒæ—¶æ›´æ–°ä¸¤ä¸ªä½ç½®çš„currentLevelä»¥ç¡®ä¿å…¼å®¹æ€§
                        const oldCurrentLevel = userProfile.currentLevel;
                        userProfile.currentLevel = currentLevel + 1;
                        userProfile.progress.currentLevel = currentLevel + 1;
                        
                        log(`æ›´æ–°currentLevel: ${oldCurrentLevel} -> ${currentLevel + 1}`, 'info');
                        
                        // æ ‡è®°å½“å‰å…³å¡ä¸ºå·²å®Œæˆ
                        if (!userProfile.progress.completedLevels.includes(currentLevel)) {
                            userProfile.progress.completedLevels.push(currentLevel);
                            log(`æ·»åŠ å·²å®Œæˆå…³å¡: ${currentLevel}`, 'info');
                        } else {
                            log(`å…³å¡${currentLevel}å·²åœ¨å®Œæˆåˆ—è¡¨ä¸­`, 'info');
                        }
                        
                        // ä¿å­˜æ¡£æ¡ˆ
                        await this.saveUserProfile(userProfile);
                        
                        log(`ğŸ”“ è§£é”å…³å¡ ${currentLevel + 1}ï¼Œå·²å®Œæˆå…³å¡: [${userProfile.progress.completedLevels.join(', ')}]`, 'success');
                    } else {
                        log(`è·³è¿‡è§£é”: currentLevel=${currentLevel}, userProfile.currentLevel=${userProfile.currentLevel}`, 'info');
                    }
                } catch (error) {
                    log('è§£é”ä¸‹ä¸€å…³å¤±è´¥: ' + error.message, 'error');
                }
            }
        }
        
        const dataManager = new DebugDataManager();
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('debugLog');
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
            logElement.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('debugLog').textContent = 'æ—¥å¿—å·²æ¸…ç©º\n';
        }
        
        function loadUserProfile() {
            try {
                const profile = dataManager.getUserProfile();
                const statusDiv = document.getElementById('userStatus');
                
                statusDiv.innerHTML = `
                    <strong>ç”¨æˆ·ID:</strong> ${profile.userId}<br>
                    <strong>å½“å‰å…³å¡:</strong> ${profile.currentLevel}<br>
                    <strong>è¿›åº¦å…³å¡:</strong> ${profile.progress.currentLevel}<br>
                    <strong>å·²å®Œæˆå…³å¡:</strong> [${profile.progress.completedLevels.join(', ')}]<br>
                    <strong>æœ€åæ›´æ–°:</strong> ${profile.lastUpdated}
                `;
                
                log('ç”¨æˆ·æ¡£æ¡ˆåŠ è½½å®Œæˆ', 'success');
            } catch (error) {
                log('åŠ è½½ç”¨æˆ·æ¡£æ¡ˆå¤±è´¥: ' + error.message, 'error');
            }
        }
        
        function resetUserProfile() {
            try {
                wx.removeStorageSync('wordHero_profile');
                wx.removeStorageSync('wordHero_profile_backup');
                
                // æ¸…é™¤æ‰€æœ‰å…³å¡å®Œæˆè®°å½•
                for (let i = 1; i <= 20; i++) {
                    wx.removeStorageSync(`level_complete_${i}`);
                }
                
                log('ç”¨æˆ·æ¡£æ¡ˆå·²é‡ç½®', 'success');
                loadUserProfile();
            } catch (error) {
                log('é‡ç½®ç”¨æˆ·æ¡£æ¡ˆå¤±è´¥: ' + error.message, 'error');
            }
        }
        
        async function simulateLevelCompletion() {
            const levelId = parseInt(document.getElementById('levelInput').value);
            const correct = parseInt(document.getElementById('correctInput').value);
            const total = parseInt(document.getElementById('totalInput').value);
            
            if (levelId < 1 || levelId > 20) {
                log('å…³å¡ç¼–å·å¿…é¡»åœ¨1-20ä¹‹é—´', 'error');
                return;
            }
            
            if (correct > total) {
                log('æ­£ç¡®æ•°é‡ä¸èƒ½å¤§äºæ€»æ•°é‡', 'error');
                return;
            }
            
            const accuracy = total > 0 ? (correct / total * 100) : 0;
            
            log(`å¼€å§‹æ¨¡æ‹Ÿå…³å¡${levelId}å®Œæˆ: ${correct}/${total} (${accuracy.toFixed(1)}%)`, 'info');
            
            try {
                const result = await dataManager.completeLevelProgress(levelId, {
                    accuracy,
                    totalWords: total,
                    correctWords: correct,
                    sessionId: 'debug_session_' + Date.now()
                });
                
                if (result) {
                    log('å…³å¡å®Œæˆæ¨¡æ‹ŸæˆåŠŸ', 'success');
                    loadUserProfile();
                } else {
                    log('å…³å¡å®Œæˆæ¨¡æ‹Ÿå¤±è´¥', 'error');
                }
            } catch (error) {
                log('æ¨¡æ‹Ÿå…³å¡å®Œæˆæ—¶å‡ºé”™: ' + error.message, 'error');
            }
        }
        
        async function unlockSpecificLevel() {
            const levelId = parseInt(document.getElementById('levelInput').value);
            
            if (levelId < 1 || levelId > 19) {
                log('å…³å¡ç¼–å·å¿…é¡»åœ¨1-19ä¹‹é—´', 'error');
                return;
            }
            
            log(`ç›´æ¥è§£é”å…³å¡${levelId + 1}...`, 'info');
            
            try {
                await dataManager.unlockNextLevel(levelId);
                loadUserProfile();
            } catch (error) {
                log('ç›´æ¥è§£é”å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        function checkAllLevels() {
            log('æ£€æŸ¥æ‰€æœ‰å…³å¡çŠ¶æ€...', 'info');
            
            const profile = dataManager.getUserProfile();
            
            for (let i = 1; i <= 20; i++) {
                const completedLevels = profile.progress.completedLevels;
                const currentLevel = profile.progress.currentLevel;
                
                let status = 'locked';
                if (completedLevels.includes(i)) {
                    status = 'completed';
                } else if (i === currentLevel) {
                    status = 'current';
                } else if (i <= currentLevel) {
                    status = 'available';
                }
                
                log(`å…³å¡${i}: ${status}`, 'info');
            }
        }
        
        function checkLevelData() {
            log('æ£€æŸ¥å…³å¡æ•°æ®ç»“æ„...', 'info');
            
            // æ¨¡æ‹Ÿå…³å¡æ•°æ®
            const mockLevelData = {
                level: 1,
                id: 1,
                theme: 'æµ‹è¯•ä¸»é¢˜',
                name: 'ç¬¬1å…³',
                words: [
                    { word: 'test', chinese: 'æµ‹è¯•' }
                ],
                totalWords: 1
            };
            
            log('æ¨¡æ‹Ÿå…³å¡æ•°æ®:', 'info');
            log(JSON.stringify(mockLevelData, null, 2), 'info');
            
            // æ£€æŸ¥å±æ€§è®¿é—®
            log(`levelData.level = ${mockLevelData.level}`, 'info');
            log(`levelData.id = ${mockLevelData.id}`, 'info');
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            log('è°ƒè¯•å·¥å…·åˆå§‹åŒ–å®Œæˆ', 'success');
            loadUserProfile();
        };
    </script>
</body>
</html>