<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>例句播放修复测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            background: #f9f9f9;
        }
        
        .test-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .word-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .word-display {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .word-text {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
            margin: 10px 0;
        }
        
        .word-meaning {
            font-size: 18px;
            color: #666;
            margin: 10px 0;
        }
        
        .sentence-area {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #3498db;
        }
        
        .sentence-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .sentence-text {
            font-size: 16px;
            color: #333;
            line-height: 1.6;
            cursor: pointer;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .sentence-text:hover {
            border-color: #3498db;
            background: #e8f4fd;
        }
        
        .sentence-text.dictation {
            background: #fff3cd;
            border-color: #ffc107;
        }
        
        .sentence-text.dictation:hover {
            background: #fff3cd;
            border-color: #ff8c00;
        }
        
        .mode-indicator {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }
        
        .mode-learn {
            background: #27ae60;
        }
        
        .mode-dictation {
            background: #f39c12;
        }
        
        .control-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 120px;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #229954;
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background: #e67e22;
            transform: translateY(-2px);
        }
        
        .log-area {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        
        .log-info {
            color: #3498db;
        }
        
        .log-success {
            color: #27ae60;
        }
        
        .log-warning {
            color: #f39c12;
        }
        
        .log-error {
            color: #e74c3c;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-success {
            background: #27ae60;
        }
        
        .status-warning {
            background: #f39c12;
        }
        
        .status-error {
            background: #e74c3c;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔊 例句播放修复测试</h1>
        
        <div class="test-section">
            <div class="test-title">
                📚 学习模式测试
                <span class="mode-indicator mode-learn">LEARN</span>
            </div>
            
            <div class="word-card">
                <div class="word-display">
                    <div class="word-text" id="learnWord">apple</div>
                    <div class="word-meaning">苹果</div>
                </div>
                
                <div class="sentence-area">
                    <div class="sentence-label">📚 读一读例句：</div>
                    <div class="sentence-text" id="learnSentence" onclick="testLearnMode()">
                        I like to eat an apple every day.
                    </div>
                </div>
                
                <div class="control-buttons">
                    <button class="btn btn-primary" onclick="switchToLearnMode()">切换到学习模式</button>
                    <button class="btn btn-success" onclick="testLearnMode()">播放学习模式例句</button>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <div class="test-title">
                ✏️ 默写模式测试
                <span class="mode-indicator mode-dictation">DICTATION</span>
            </div>
            
            <div class="word-card">
                <div class="word-display">
                    <div class="word-text" id="dictationWord">apple</div>
                    <div class="word-meaning">苹果</div>
                </div>
                
                <div class="sentence-area">
                    <div class="sentence-label">📚 读一读例句：</div>
                    <div class="sentence-text dictation" id="dictationSentence" onclick="testDictationMode()">
                        I like to eat an _____ every day.
                    </div>
                </div>
                
                <div class="control-buttons">
                    <button class="btn btn-warning" onclick="switchToDictationMode()">切换到默写模式</button>
                    <button class="btn btn-success" onclick="testDictationMode()">播放默写模式例句</button>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <div class="test-title">
                🔄 模式切换测试
            </div>
            
            <div class="control-buttons">
                <button class="btn btn-primary" onclick="testModeSwitch()">测试快速模式切换</button>
                <button class="btn btn-warning" onclick="testDataConsistency()">测试数据一致性</button>
                <button class="btn btn-success" onclick="clearLogs()">清除日志</button>
            </div>
        </div>
        
        <div class="log-area" id="logArea">
            <div class="log-entry log-info">🚀 例句播放修复测试已启动</div>
            <div class="log-entry log-info">📋 测试说明：点击例句文本或按钮来测试播放功能</div>
        </div>
    </div>

    <script>
        // 模拟小程序环境
        const wx = {
            showToast: function(options) {
                addLog(`📱 Toast: ${options.title}`, 'warning');
                alert(options.title);
            }
        };
        
        // 模拟音频服务
        function playSentencePronunciation(text) {
            return new Promise((resolve, reject) => {
                addLog(`🎵 播放例句: "${text}"`, 'success');
                
                // 模拟播放延迟
                setTimeout(() => {
                    if (Math.random() > 0.1) { // 90% 成功率
                        addLog(`✅ 播放成功: "${text}"`, 'success');
                        resolve();
                    } else {
                        addLog(`❌ 播放失败: "${text}"`, 'error');
                        reject(new Error('模拟播放失败'));
                    }
                }, 500);
            });
        }
        
        // 模拟页面数据
        let pageData = {
            currentWord: {
                word: 'apple',
                chinese: '苹果',
                sentence: 'I like to eat an apple every day.'
            },
            sentenceWithBlank: '',
            mode: 'learn'
        };
        
        // 模拟 onPlaySentence 方法（修复后的版本）
        function onPlaySentence() {
            const { currentWord, sentenceWithBlank, mode } = pageData;
            
            addLog('🔊 开始播放例句', 'info');
            addLog(`📋 当前模式: ${mode}`, 'info');
            addLog(`📝 当前单词: ${JSON.stringify(currentWord)}`, 'info');
            addLog(`📄 带空白例句: "${sentenceWithBlank}"`, 'info');
            
            // 确定要播放的例句内容
            let sentenceText = '';
            
            if (mode === 'dictation' && sentenceWithBlank) {
                // 默写模式：播放完整例句（将空白替换为单词）
                const blankPattern = /_+/g;
                sentenceText = sentenceWithBlank.replace(blankPattern, currentWord.word);
                addLog(`🎯 默写模式 - 播放完整例句: "${sentenceText}"`, 'info');
            } else if (mode === 'learn' && currentWord && currentWord.sentence) {
                // 学习模式：播放完整例句
                sentenceText = currentWord.sentence;
                addLog(`📚 学习模式 - 播放完整例句: "${sentenceText}"`, 'info');
            } else {
                // 兜底逻辑：尝试使用当前单词的例句
                if (currentWord && currentWord.sentence) {
                    sentenceText = currentWord.sentence;
                    addLog(`🔄 兜底逻辑 - 使用当前单词例句: "${sentenceText}"`, 'warning');
                }
            }
            
            if (!sentenceText) {
                addLog('❌ 无法确定要播放的例句内容', 'error');
                addLog('📊 调试信息:', 'error');
                addLog(`  - mode: ${mode}`, 'error');
                addLog(`  - currentWord: ${JSON.stringify(currentWord)}`, 'error');
                addLog(`  - sentenceWithBlank: "${sentenceWithBlank}"`, 'error');
                
                wx.showToast({
                    title: '例句数据无效',
                    icon: 'none'
                });
                return;
            }

            addLog(`✅ 确定播放例句: "${sentenceText}"`, 'success');
            
            playSentencePronunciation(sentenceText)
                .then(() => {
                    addLog(`🎵 播放例句成功: "${sentenceText}"`, 'success');
                })
                .catch((error) => {
                    addLog(`❌ 播放例句失败: ${error.message}`, 'error');
                    wx.showToast({
                        title: '例句播放失败',
                        icon: 'none'
                    });
                });
        }
        
        // 模拟 createSentenceWithBlank 方法
        function createSentenceWithBlank(sentence, word) {
            if (!sentence || !word) return '';
            
            // 使用正则表达式替换单词（不区分大小写）
            const regex = new RegExp(`\\b${word}\\b`, 'gi');
            const blank = '_'.repeat(word.length);
            return sentence.replace(regex, blank);
        }
        
        // 测试函数
        function testLearnMode() {
            addLog('🧪 测试学习模式例句播放', 'info');
            onPlaySentence();
        }
        
        function testDictationMode() {
            addLog('🧪 测试默写模式例句播放', 'info');
            onPlaySentence();
        }
        
        function switchToLearnMode() {
            addLog('🔄 切换到学习模式', 'info');
            pageData.mode = 'learn';
            pageData.sentenceWithBlank = '';
            
            // 更新UI
            document.getElementById('learnSentence').textContent = pageData.currentWord.sentence;
            
            addLog('✅ 学习模式数据设置完成，已清除默写模式残留数据', 'success');
        }
        
        function switchToDictationMode() {
            addLog('🔄 切换到默写模式', 'info');
            pageData.mode = 'dictation';
            
            // 生成填空句子
            addLog('📝 生成填空句子:', 'info');
            addLog(`  - 原始例句: "${pageData.currentWord.sentence}"`, 'info');
            addLog(`  - 目标单词: "${pageData.currentWord.word}"`, 'info');
            
            const sentenceWithBlank = createSentenceWithBlank(pageData.currentWord.sentence, pageData.currentWord.word);
            pageData.sentenceWithBlank = sentenceWithBlank;
            
            addLog(`  - 生成的填空句子: "${sentenceWithBlank}"`, 'info');
            
            // 更新UI
            document.getElementById('dictationSentence').textContent = sentenceWithBlank;
            
            addLog('✅ 默写模式数据设置完成:', 'success');
            addLog(`  - mode: ${pageData.mode}`, 'success');
            addLog(`  - sentenceWithBlank: "${pageData.sentenceWithBlank}"`, 'success');
        }
        
        function testModeSwitch() {
            addLog('🧪 开始快速模式切换测试', 'info');
            
            // 快速切换模式并测试播放
            setTimeout(() => {
                switchToLearnMode();
                setTimeout(() => {
                    testLearnMode();
                    setTimeout(() => {
                        switchToDictationMode();
                        setTimeout(() => {
                            testDictationMode();
                            addLog('✅ 快速模式切换测试完成', 'success');
                        }, 1000);
                    }, 1000);
                }, 1000);
            }, 500);
        }
        
        function testDataConsistency() {
            addLog('🧪 开始数据一致性测试', 'info');
            
            // 测试各种边界情况
            const originalData = { ...pageData };
            
            // 测试1：空数据
            pageData.currentWord = null;
            addLog('🔍 测试空单词数据', 'warning');
            onPlaySentence();
            
            // 恢复数据
            pageData = { ...originalData };
            
            setTimeout(() => {
                // 测试2：缺少例句
                pageData.currentWord = { word: 'test', chinese: '测试' };
                addLog('🔍 测试缺少例句数据', 'warning');
                onPlaySentence();
                
                // 恢复数据
                pageData = { ...originalData };
                
                setTimeout(() => {
                    // 测试3：模式不匹配
                    pageData.mode = 'unknown';
                    addLog('🔍 测试未知模式', 'warning');
                    onPlaySentence();
                    
                    // 恢复数据
                    pageData = { ...originalData };
                    addLog('✅ 数据一致性测试完成', 'success');
                }, 2000);
            }, 2000);
        }
        
        function addLog(message, type = 'info') {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        function clearLogs() {
            const logArea = document.getElementById('logArea');
            logArea.innerHTML = '<div class="log-entry log-info">🧹 日志已清除</div>';
        }
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            addLog('🎯 页面加载完成，准备开始测试', 'success');
            addLog('💡 提示：点击例句文本或使用控制按钮进行测试', 'info');
            
            // 初始化为学习模式
            switchToLearnMode();
        });
    </script>
</body>
</html>