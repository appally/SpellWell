<!-- pages/word-learning/word-learning.wxml -->

<scroll-view class="page-scroll" scroll-y="true" enable-back-to-top="true">
<view class="safe-area">
  <!-- é¡¶éƒ¨å¯¼èˆªæ å·²ç§»é™¤ -->

  <!-- è¿›åº¦æ¡ -->
  <view class="progress-container">
    <view class="progress-header">
      <view class="progress-text">å­¦ä¹ è¿›åº¦</view>
      <view class="progress-number">{{currentWordIndex + 1}}/{{levelData.words.length}}</view>
    </view>
    <view class="progress-bar">
      <view class="progress-fill" style="width: {{progressPercentage}}%;"></view>
    </view>
  </view>

  <!-- å­¦ä¹ æ¨¡å¼ -->
  <view class="word-card" wx:if="{{mode === 'learn'}}">
    <!-- å•è¯ä¿¡æ¯ -->
    <view class="word-display">
      <view class="word-image">{{currentWord.image || 'ğŸ“š'}}</view>
      <view class="word-text">{{currentWord.word}}</view>
      <view class="word-phonetic">{{currentWord.phonetic}}</view>
      <view class="word-meaning">{{currentWord.chinese}}</view>
      
      <!-- ä¾‹å¥åŒºåŸŸ - ç»Ÿä¸€æ ·å¼ -->
      <view class="sentence-simple" wx:if="{{currentWord.sentence && mode === 'learn'}}">
        <view class="sentence-simple-label">ğŸ“š è¯»ä¸€è¯»ä¾‹å¥ï¼š</view>
        <text class="sentence-simple-text">{{currentWord.sentence}}</text>
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="action-buttons-row">
      <button 
        class="btn btn-ai"
        bindtap="onGetAIExplanation"
        disabled="{{isLoadingAI}}"
      >
        {{isLoadingAI ? 'ç”Ÿæˆä¸­...' : 'ğŸ¤– AIè®²è§£'}}
      </button>
      <button class="btn btn-learned" bindtap="onConfirmLearning">
        ğŸ“ å­¦ä¼šäº†
      </button>
    </view>
  </view>

  <!-- AIè®²è§£å¼¹çª— -->
  <view class="ai-overlay {{showAIExplanation ? 'show' : ''}}" wx:if="{{showAIExplanation}}" bindtap="onCloseAIExplanation">
    <view class="ai-card-enhanced" catchtap="">
      <view class="ai-close-btn" bindtap="onCloseAIExplanation">
        <text class="close-icon">âœ•</text>
      </view>
      
      <!-- LoadingçŠ¶æ€ -->
      <view class="ai-loading" wx:if="{{isLoadingAI}}">
        <view class="loading-robot">ğŸ¤–</view>
        <view class="loading-text">{{loadingText}}</view>
        <view class="loading-dots">
          <view class="dot"></view>
          <view class="dot"></view>
          <view class="dot"></view>
        </view>
      </view>
      
      <!-- å†…å®¹çŠ¶æ€ -->
      <view wx:else>
        <view class="ai-header-enhanced">
          <view class="ai-avatar">ğŸ¤–</view>
          <view class="ai-title-enhanced">AIè€å¸ˆå°è´´å£«</view>
        </view>
        <view class="ai-content-enhanced">
          <view class="ai-explanation-enhanced">{{aiExplanation}}</view>
          
          <!-- æŸ¥çœ‹è¯¦ç»†æŒ‰é’® -->
          <view class="ai-action-buttons" wx:if="{{aiExplanation && !showDetailedMode}}">
            <button class="btn-detailed" bindtap="onShowDetailedExplanation">
              ğŸ“š æŸ¥çœ‹è¯¦ç»†è®²è§£
            </button>
          </view>
        </view>
        <view class="ai-footer">
          <view class="ai-tip">ğŸ’¡ ä¸“ä¸ºå°æœ‹å‹è®¾è®¡çš„å­¦ä¹ åŠ©æ‰‹</view>
        </view>
      </view>
    </view>
  </view>

  <!-- é»˜å†™æ¨¡å¼ - ä¸å­¦ä¹ æ¨¡å¼ç»Ÿä¸€è®¾è®¡ -->
  <view class="word-card" wx:if="{{mode === 'dictation'}}">
    <!-- å•è¯ä¿¡æ¯ - ç®€æ´è®¾è®¡ -->
    <view class="word-display dictation-display">
      <view class="word-image">ğŸ¯</view>
      <view class="word-meaning-primary">{{currentWord.chinese}}</view>
      <view class="word-phonetic">{{currentWord.phonetic}}</view>
    </view>

    <!-- ä¾‹å¥å¡«ç©º - ç®€åŒ–ä¸ºå•å±‚ç»“æ„ -->
    <view class="sentence-simple" wx:if="{{sentenceWithBlank}}">
      <view class="sentence-simple-label">ğŸ“š è¯»ä¸€è¯»ä¾‹å¥ï¼š</view>
      <text class="sentence-simple-text">{{sentenceWithBlank}}</text>
    </view>

    <!-- ç»Ÿä¸€æ¸¸æˆåŒºåŸŸ - æ•´åˆæ‹¼å†™å’Œå­—æ¯é€‰æ‹© -->
    <view class="unified-game-area">
      <!-- ç­”æ¡ˆæ˜¾ç¤º -->
      <view class="answer-section">
        <view class="answer-label">ç‚¹å‡»å­—æ¯æ‹¼å‡ºå•è¯ï¼š</view>
        <view class="answer-display">
          <view 
            class="answer-letter {{item.status}}" 
            wx:for="{{userAnswer}}" 
            wx:for-item="item"
            wx:for-index="idx"
            wx:key="{{idx}}"
          >
            {{item.char}}
          </view>
          <view class="cursor" wx:if="{{userAnswer.length < targetWord.length}}">|</view>
        </view>
      </view>

      <!-- å­—æ¯é€‰æ‹© -->
      <view class="letters-section">
        <view class="letters-grid">
          <view 
            class="letter-btn {{item.used ? 'used' : ''}} {{item.correct ? 'correct' : ''}}" 
            wx:for="{{shuffledLetters}}" 
            wx:for-item="item"
            wx:for-index="idx"
            wx:key="{{idx}}"
            bindtap="onLetterTap"
            data-index="{{idx}}"
          >
            {{item.char}}
          </view>
        </view>
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’® - ç»Ÿä¸€æ ·å¼ -->
    <view class="action-buttons-row dictation-actions">
      <button class="btn btn-reset" bindtap="onResetAnswer" wx:if="{{userAnswer.length > 0}}">
        ğŸ”„ é‡æ–°å¼€å§‹
      </button>
      <button class="btn btn-hint" bindtap="onShowLetterHint" wx:if="{{userAnswer.length > 0 && showHintOption}}">
        ğŸ’¡ æç¤º
      </button>
    </view>

    <!-- å®Œæˆæç¤ºå·²ç§»é™¤ - ç»Ÿä¸€ä½¿ç”¨åé¦ˆå¼¹çª—æ˜¾ç¤ºåº†ç¥ä¿¡æ¯ -->
  </view>

  <!-- ç¡®è®¤æ¨¡å¼ï¼ˆä¿ç•™ä½œä¸ºå¤‡ç”¨ï¼‰ -->
  <view class="confirm-card" wx:if="{{mode === 'confirm'}}">
    <view class="confirm-content">
      <view class="confirm-icon">ğŸ¯</view>
      <view class="confirm-title">ç¡®è®¤æŒæ¡</view>
      <view class="confirm-message">ä½ å·²ç»æŒæ¡äº†å•è¯ "{{currentWord.word}}" å—ï¼Ÿ</view>
      
      <view class="confirm-buttons">
        <button class="btn btn-outline" bindtap="onNeedRelearn">
          éœ€è¦å†å­¦ä¹ 
        </button>
        <button class="btn btn-primary" bindtap="onConfirmMastery">
          ç¡®è®¤æŒæ¡
        </button>
      </view>
    </view>
  </view>

  <!-- ç»Ÿè®¡ä¿¡æ¯ -->
  <view class="stats-container" wx:if="{{mode !== 'result'}}">
    <view class="stat-item">
      <view class="stat-value">{{stats.correct}}</view>
      <view class="stat-label">å·²æŒæ¡</view>
    </view>
    <view class="stat-item">
      <view class="stat-value">{{stats.streak}}</view>
      <view class="stat-label">è¿ç»­æ­£ç¡®</view>
    </view>
    <view class="stat-item">
      <view class="stat-value">{{accuracyPercentage}}%</view>
      <view class="stat-label">å‡†ç¡®ç‡</view>
    </view>
  </view>
</view>
</scroll-view>

<!-- åé¦ˆå¼¹çª— -->
<view class="feedback-overlay {{showFeedback ? 'show' : ''}}" wx:if="{{showFeedback}}">
  <view class="feedback-card">
    <view class="feedback-icon">{{feedbackData.success ? 'ğŸ‰' : 'ğŸ’ª'}}</view>
    <view class="feedback-title">{{feedbackData.success ? 'å¤ªæ£’äº†ï¼' : 'ç»§ç»­åŠ æ²¹ï¼'}}</view>
    <view class="feedback-message">{{feedbackData.message}}</view>
    <view class="feedback-word">{{feedbackData.word}}</view>
  </view>
</view>