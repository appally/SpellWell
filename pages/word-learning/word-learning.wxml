<!-- pages/word-learning/word-learning.wxml -->

<scroll-view class="page-scroll" scroll-y="true" enable-back-to-top="true">
<view class="safe-area">
  <!-- é¡¶éƒ¨å¯¼èˆªæ å·²ç§»é™¤ -->

  <!-- è¿›åº¦æ¡ -->
  <view class="progress-container">
    <view class="progress-header">
      <view class="progress-text">å­¦ä¹ è¿›åº¦</view>
      <view class="progress-number">{{currentWordIndex + 1}}/{{levelData.words.length}}</view>
    </view>
    <view class="progress-bar">
      <view class="progress-fill" style="width: {{progressPercentage}}%;"></view>
    </view>
  </view>

  <!-- å­¦ä¹ æ¨¡å¼ -->
  <view class="word-card" wx:if="{{mode === 'learn'}}">
    <!-- å•è¯ä¿¡æ¯ -->
    <view class="word-display">
      <view class="word-image">{{currentWord.image || 'ğŸ“š'}}</view>
      <view class="word-text {{wordAudioLoading ? 'loading' : ''}}" bindtap="onPlayPronunciation">{{currentWord.word}}</view>
      <view class="word-phonetic-container">
        <view class="word-phonetic">{{currentWord.phonetic}}</view>
        <view class="pronunciation-btn" bindtap="onPlayPronunciation">
          <view class="pronunciation-icon">ğŸ”Š</view>
        </view>
      </view>
      <view class="word-meaning">{{currentWord.chinese}}</view>
      
      <!-- ä¾‹å¥åŒºåŸŸ - ç»Ÿä¸€æ ·å¼ -->
      <view class="sentence-simple" wx:if="{{currentWord.sentence && mode === 'learn'}}">
        <view class="sentence-simple-label">ğŸ“š è¯»ä¸€è¯»ä¾‹å¥ï¼š</view>
        <text class="sentence-simple-text {{sentenceAudioLoading ? 'loading' : ''}}" bindtap="onPlaySentence">{{currentWord.sentence}}</text>
      </view>
      
      <!-- å­¦ä¹ å°è´´å£« -->
      <view class="word-tips" wx:if="{{currentWord.tips && currentWord.tips.length > 0 && mode === 'learn'}}">
        <view class="tips-label">ğŸ’¡ å­¦ä¹ å°è´´å£«ï¼š</view>
        <view class="tips-list">
          <view class="tip-item" wx:for="{{currentWord.tips}}" wx:key="*this">
            <text class="tip-text">â€¢ {{item}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- å­¦ä¹ æ¨¡å¼æ“ä½œæŒ‰é’® - ç§»åˆ°word-cardå¤–éƒ¨ -->
  <view class="action-buttons-row neo-brutalism-buttons" wx:if="{{mode === 'learn'}}">
    <button 
      class="neo-btn neo-btn-ai"
      bindtap="onGetAIExplanation"
    >
      <view class="btn-icon">ğŸ¤–</view>
      <view class="btn-text">é­”æ³•è€å¸ˆ</view>
      <view class="btn-decoration"></view>
    </button>
    <button class="neo-btn neo-btn-learned" bindtap="onConfirmLearning">
      <view class="btn-icon">ğŸ“</view>
      <view class="btn-text">å­¦ä¼šäº†</view>
      <view class="btn-decoration"></view>
    </button>
  </view>



  <!-- é»˜å†™æ¨¡å¼ - ä¸å­¦ä¹ æ¨¡å¼ç»Ÿä¸€è®¾è®¡ -->
  <view class="word-card" wx:if="{{mode === 'dictation'}}">
    <!-- å•è¯ä¿¡æ¯ - ç®€æ´è®¾è®¡ -->
    <view class="word-display dictation-display">
      <view class="word-image">{{currentWord.image || 'ğŸ“š'}}</view>
      <view class="word-meaning-primary">{{currentWord.chinese}}</view>
      <view class="word-phonetic-container">
        <view class="word-phonetic">{{currentWord.phonetic}}</view>
        <view class="pronunciation-btn" bindtap="onPlayPronunciation">
          <view class="pronunciation-icon">ğŸ”Š</view>
        </view>
      </view>
    </view>

    <!-- ä¾‹å¥å¡«ç©º - ç®€åŒ–ä¸ºå•å±‚ç»“æ„ -->
    <view class="sentence-simple" wx:if="{{sentenceWithBlank}}">
      <view class="sentence-simple-label">ğŸ“š è¯»ä¸€è¯»ä¾‹å¥ï¼š</view>
      <view class="sentence-container">
        <text class="sentence-simple-text {{sentenceAudioLoading ? 'loading' : ''}}" bindtap="onPlaySentence" wx:if="{{!sentenceWordAnimation}}">{{sentenceWithBlank}}</text>
        <!-- å¸¦åŠ¨ç”»å•è¯çš„ä¾‹å¥ -->
        <rich-text class="sentence-simple-text {{sentenceAudioLoading ? 'loading' : ''}}" nodes="{{sentenceWithWord}}" bindtap="onPlaySentence" wx:if="{{sentenceWordAnimation}}"></rich-text>
      </view>
    </view>

    <!-- ç»Ÿä¸€æ¸¸æˆåŒºåŸŸ - æ•´åˆæ‹¼å†™å’Œå­—æ¯é€‰æ‹© -->
    <view class="unified-game-area">
      <!-- ç­”æ¡ˆæ˜¾ç¤º -->
      <view class="answer-section">
        <view class="answer-label">ç‚¹å‡»å­—æ¯æ‹¼å‡ºå•è¯ï¼š</view>
        <view class="answer-display">
          <!-- å››çº¿ä¸‰æ ¼çº¿æ¡ -->
          <view class="four-line-grid">
            <view class="grid-line line-1"></view>
            <view class="grid-line line-2 main-line"></view>
            <view class="grid-line line-3"></view>
            <view class="grid-line line-4"></view>
          </view>
          <!-- å­—æ¯å†…å®¹ -->
          <view class="answer-content {{explodeAnimation ? 'explode-content' : ''}} {{answerCompleted ? 'completed' : ''}}">
            <view 
              class="answer-letter {{item.status}} {{wordFlashAnimation ? 'flash-letter' : ''}}"
              wx:for="{{userAnswer}}" 
              wx:for-item="item"
              wx:for-index="idx"
              wx:key="{{idx}}"
              data-letter="{{item.char}}"
            >
              {{item.char}}
            </view>
            <view class="cursor" wx:if="{{userAnswer.length < targetWord.length && !explodeAnimation}}">|</view>
          </view>
        </view>
      </view>

      <!-- å­—æ¯é€‰æ‹© -->
      <view class="letters-section">
        <view class="letters-grid">
          <view 
            class="letter-btn {{item.used ? 'used' : ''}} {{item.correct ? 'correct' : ''}}" 
            wx:for="{{shuffledLetters}}" 
            wx:for-item="item"
            wx:for-index="idx"
            wx:key="{{idx}}"
            bindtap="onLetterTap"
            data-index="{{idx}}"
          >
            {{item.char}}
          </view>
        </view>
      </view>
    </view>

  </view>



    <!-- å®Œæˆæç¤ºå·²ç§»é™¤ - ç»Ÿä¸€ä½¿ç”¨åé¦ˆå¼¹çª—æ˜¾ç¤ºåº†ç¥ä¿¡æ¯ -->

  <!-- ç¡®è®¤æ¨¡å¼ï¼ˆä¿ç•™ä½œä¸ºå¤‡ç”¨ï¼‰ -->
  <view class="confirm-card" wx:if="{{mode === 'confirm'}}">
    <view class="confirm-content">
      <view class="confirm-icon">ğŸ¯</view>
      <view class="confirm-title">ç¡®è®¤æŒæ¡</view>
      <view class="confirm-message">ä½ å·²ç»æŒæ¡äº†å•è¯ "{{currentWord.word}}" å—ï¼Ÿ</view>
      
      <view class="confirm-buttons">
        <button class="btn btn-outline" bindtap="onNeedRelearn">
          éœ€è¦å†å­¦ä¹ 
        </button>
        <button class="btn btn-primary" bindtap="onConfirmMastery">
          ç¡®è®¤æŒæ¡
        </button>
      </view>
    </view>
  </view>


</view>
</scroll-view>

<!-- ç®€åŒ–åº†ç¥åŠ¨ç”»å±‚ -->
<view class="celebration-animation-overlay {{showCelebrationAnimation ? 'show' : ''}}" wx:if="{{showCelebrationAnimation}}" bindtap="onSkipCelebration">
  <!-- ç®€åŒ–åº†ç¥æ•ˆæœ -->
  <view class="simple-celebration">
    <view class="celebration-emoji emoji-icon emoji-party xxl"></view>
    <view class="celebration-word">{{celebrationWord}}</view>
  </view>
</view>

<!-- å…³å¡å®Œæˆåº†ç¥å¼¹çª— -->
<view class="celebration-overlay {{showCelebration ? 'show' : ''}}" wx:if="{{showCelebration}}">
  <view class="celebration-background">
    <!-- çƒŸèŠ±åŠ¨ç”»èƒŒæ™¯ -->
    <view class="firework firework-1"></view>
    <view class="firework firework-2"></view>
    <view class="firework firework-3"></view>
    <view class="firework firework-4"></view>
    
    <!-- é£˜è½çš„æ˜Ÿæ˜Ÿ -->
    <view class="falling-star star-1 emoji-icon emoji-star"></view>
    <view class="falling-star star-2 emoji-icon emoji-sparkles"></view>
    <view class="falling-star star-3 emoji-icon emoji-glowing-star"></view>
    <view class="falling-star star-4 emoji-icon emoji-dizzy"></view>
    <view class="falling-star star-5 emoji-icon emoji-star"></view>
    <view class="falling-star star-6 emoji-icon emoji-sparkles"></view>
  </view>
  
  <view class="celebration-card">
    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <view class="main-content">
      <!-- å·¦ä¾§ï¼šå¥–æ¯å’Œæ ‡é¢˜ -->
      <view class="left-section">
        <view class="trophy-container">
          <view class="trophy-icon emoji-icon emoji-trophy xxl"></view>
          <view class="trophy-glow"></view>
        </view>
        <view class="celebration-title">
          <view class="title-main">å…³å¡å®Œæˆï¼</view>
          <view class="title-sub">Level {{levelData.level}} é€šå…³</view>
        </view>
      </view>
      
      <!-- å³ä¾§ï¼šæˆç»©å’Œæ˜Ÿçº§ -->
      <view class="right-section">
        <view class="score-display">
          <view class="score-item">
            <view class="score-number">{{errorWords}}</view>
            <view class="score-label">å‡ºé”™å•è¯</view>
          </view>
          <view class="score-divider">|</view>
          <view class="score-item">
            <view class="score-number">{{errorCount}}</view>
            <view class="score-label">é”™è¯¯æ¬¡æ•°</view>
          </view>
        </view>
        
        <view class="star-rating">
          <view class="star-item {{starRating >= 1 ? 'active' : ''}} emoji-icon emoji-star"></view>
          <view class="star-item {{starRating >= 2 ? 'active' : ''}} emoji-icon emoji-star"></view>
          <view class="star-item {{starRating >= 3 ? 'active' : ''}} emoji-icon emoji-star"></view>
        </view>
      </view>
    </view>
    
    <!-- å¥–åŠ±ä¿¡æ¯ -->
    <view class="bottom-content">
      <view class="reward-info">
        <view class="reward-text"><view class="emoji-icon emoji-gift"></view> è·å¾—å¥–åŠ±</view>
        <view class="reward-items-horizontal">
          <view class="reward-item">
            <view class="reward-icon emoji-icon emoji-medal"></view>
            <view class="reward-name">å­¦ä¹ å¾½ç« </view>
          </view>
          <view class="reward-separator">+</view>
          <view class="reward-item">
            <view class="reward-icon emoji-icon emoji-lightning"></view>
            <view class="reward-name">ç»éªŒå€¼ {{experienceGained}}</view>
          </view>
        </view>
      </view>
    </view>
    
    <!-- è‡ªåŠ¨è·³è½¬æç¤º -->
    <view class="auto-redirect">
      <view class="redirect-text">{{countdownSeconds}}ç§’åè‡ªåŠ¨è¿›å…¥ä¸‹ä¸€å…³</view>
      <view class="redirect-progress">
        <view class="redirect-bar" style="width: {{(3-countdownSeconds)/3*100}}%"></view>
      </view>
    </view>
    
    <!-- è¿›å…¥ä¸‹ä¸€å…³æŒ‰é’® -->
    <view class="celebration-button" bindtap="onReturnToMap">
      <view class="button-text">è¿›å…¥ä¸‹ä¸€å…³</view>
      <view class="button-icon emoji-icon emoji-arrow-right"></view>
    </view>
  </view>
</view>

<!-- è®°å¿†æ–¹æ³•å¼¹çª— -->
<view class="memory-tip-modal" wx:if="{{showMemoryTip}}">
  <view class="memory-tip-mask" bindtap="onCloseMemoryTip"></view>
  <view class="memory-tip-container">
    <!-- å¼¹çª—å¤´éƒ¨ -->
    <view class="memory-tip-header">
      <view class="memory-tip-title">
        <view class="title-icon">ğŸ§ </view>
        <view class="title-text">è®°å¿†é­”æ³•å±‹</view>
      </view>
      <view class="memory-tip-close" bindtap="onCloseMemoryTip">âœ•</view>
    </view>
    
    <!-- å•è¯ä¿¡æ¯ -->
    <view class="memory-tip-word">
      <view class="word-display-mini">
        <view class="word-text-mini">{{currentWord.word}}</view>
        <view class="word-meaning-mini">{{currentWord.chinese}}</view>
      </view>
    </view>
    
    <!-- è®°å¿†æ–¹æ³•å†…å®¹ -->
    <view class="memory-tip-content">
      <view class="loading-container" wx:if="{{memoryTipLoading}}">
        <view class="loading-spinner"></view>
        <view class="loading-text">é­”æ³•è€å¸ˆæ­£åœ¨ä¸ºä½ å‡†å¤‡è®°å¿†æ–¹æ³•...</view>
      </view>
      
      <view class="memory-content" wx:if="{{!memoryTipLoading && memoryTipContent}}">
        <text class="memory-text">{{memoryTipContent}}</text>
      </view>
    </view>
    
    <!-- æ“ä½œæŒ‰é’® -->
    <view class="memory-tip-actions" wx:if="{{!memoryTipLoading}}">
      <button class="memory-btn memory-btn-practice" bindtap="onContinuePractice">
        <view class="btn-icon">ğŸ”„</view>
        <view class="btn-text">ç»§ç»­ç»ƒä¹ </view>
      </button>
      <button class="memory-btn memory-btn-skip" bindtap="onSkipWord">
        <view class="btn-icon">â­ï¸</view>
        <view class="btn-text">è·³è¿‡å•è¯</view>
      </button>
    </view>
  </view>
</view>