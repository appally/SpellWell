<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…³å¡è¿›åº¦ä¿å­˜æµ‹è¯• - ä¿®å¤ç‰ˆ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2em;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e1e5e9;
            border-radius: 15px;
            background: #f8f9fa;
        }
        
        .test-section h3 {
            margin-top: 0;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 10px;
        }
        
        .status {
            background: #fff;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #007bff;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        button {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button.danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
        }
        
        button.success {
            background: linear-gradient(45deg, #28a745, #218838);
        }
        
        button.warning {
            background: linear-gradient(45deg, #ffc107, #e0a800);
            color: #212529;
        }
        
        .progress-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .progress-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
            text-align: center;
        }
        
        .progress-card h4 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 14px;
        }
        
        .progress-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 8px;
            border-radius: 5px;
        }
        
        .log-info { background: #d1ecf1; color: #0c5460; }
        .log-success { background: #d4edda; color: #155724; }
        .log-error { background: #f8d7da; color: #721c24; }
        .log-warning { background: #fff3cd; color: #856404; }
        
        .scenario-test {
            background: #e7f3ff;
            border: 2px solid #007bff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
        }
        
        .scenario-test h4 {
            margin: 0 0 10px 0;
            color: #007bff;
        }
        
        .step {
            margin: 8px 0;
            padding: 8px;
            background: white;
            border-radius: 5px;
            border-left: 3px solid #007bff;
        }
        
        .fix-highlight {
            background: #d4edda;
            border: 2px solid #28a745;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        
        .fix-highlight h4 {
            color: #155724;
            margin: 0 0 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ® å…³å¡è¿›åº¦ä¿å­˜æµ‹è¯• - ä¿®å¤ç‰ˆ</h1>
        
        <div class="fix-highlight">
            <h4>ğŸ”§ ä¿®å¤å†…å®¹</h4>
            <p><strong>é—®é¢˜ï¼š</strong>æ£€æµ‹åˆ°è¿›åº¦åä»ç„¶é‡æ–°å¼€å§‹é»˜å†™</p>
            <p><strong>åŸå› ï¼š</strong>restoreProgressæ–¹æ³•æ²¡æœ‰è°ƒç”¨loadCurrentWord()ï¼Œå¯¼è‡´é¡µé¢æ˜¾ç¤ºé”™è¯¯çš„å•è¯</p>
            <p><strong>ä¿®å¤ï¼š</strong>åœ¨restoreProgressä¸­æ·»åŠ loadCurrentWord()è°ƒç”¨ï¼Œå¹¶ä¼˜åŒ–åŠ è½½æ—¶åº</p>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“Š å½“å‰çŠ¶æ€</h3>
            <div class="progress-info">
                <div class="progress-card">
                    <h4>å…³å¡ID</h4>
                    <div class="value" id="currentLevel">-</div>
                </div>
                <div class="progress-card">
                    <h4>å½“å‰å•è¯ç´¢å¼•</h4>
                    <div class="value" id="currentWordIndex">-</div>
                </div>
                <div class="progress-card">
                    <h4>æ­£ç¡®/æ€»æ•°</h4>
                    <div class="value" id="statsDisplay">-/-</div>
                </div>
                <div class="progress-card">
                    <h4>å­¦ä¹ æ¨¡å¼</h4>
                    <div class="value" id="currentMode">-</div>
                </div>
            </div>
            <button onclick="refreshStatus()">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
            <button onclick="clearAllProgress()" class="danger">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è¿›åº¦</button>
        </div>
        
        <div class="test-section">
            <h3>ğŸ§ª åœºæ™¯æµ‹è¯•</h3>
            
            <div class="scenario-test">
                <h4>åœºæ™¯1ï¼šæ­£å¸¸è¿›åº¦ä¿å­˜å’Œæ¢å¤</h4>
                <div class="step">æ­¥éª¤1ï¼šæ¨¡æ‹Ÿå­¦ä¹ åˆ°ç¬¬5ä¸ªå•è¯</div>
                <div class="step">æ­¥éª¤2ï¼šæµ‹è¯•è¿›åº¦æ¢å¤ï¼Œåº”è¯¥ä»ç¬¬5ä¸ªå•è¯ç»§ç»­</div>
                <button onclick="testScenario1()" class="success">ğŸ¯ æµ‹è¯•åœºæ™¯1</button>
            </div>
            
            <div class="scenario-test">
                <h4>åœºæ™¯2ï¼šç”¨æˆ·é€‰æ‹©é‡æ–°å¼€å§‹</h4>
                <div class="step">æ­¥éª¤1ï¼šæ¨¡æ‹Ÿå­¦ä¹ åˆ°ç¬¬3ä¸ªå•è¯</div>
                <div class="step">æ­¥éª¤2ï¼šæµ‹è¯•è¿›åº¦æ¢å¤ï¼Œæ¨¡æ‹Ÿç”¨æˆ·é€‰æ‹©é‡æ–°å¼€å§‹</div>
                <button onclick="testScenario2()" class="warning">ğŸ”„ æµ‹è¯•åœºæ™¯2</button>
            </div>
            
            <div class="scenario-test">
                <h4>åœºæ™¯3ï¼šå¤šå…³å¡è¿›åº¦ç®¡ç†</h4>
                <div class="step">æ­¥éª¤1ï¼šåœ¨å¤šä¸ªå…³å¡ä¸­ä¿å­˜è¿›åº¦</div>
                <div class="step">æ­¥éª¤2ï¼šæµ‹è¯•ä¸åŒå…³å¡çš„è¿›åº¦æ¢å¤</div>
                <button onclick="testScenario3()" class="success">ğŸ® æµ‹è¯•åœºæ™¯3</button>
            </div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ”§ æ‰‹åŠ¨æµ‹è¯•</h3>
            <button onclick="simulateProgress(1, 0)">ğŸ“ å…³å¡1å¼€å§‹</button>
            <button onclick="simulateProgress(1, 3)">ğŸ“ å…³å¡1ç¬¬4ä¸ªå•è¯</button>
            <button onclick="simulateProgress(1, 7)">ğŸ“ å…³å¡1ç¬¬8ä¸ªå•è¯</button>
            <button onclick="simulateProgress(2, 2)">ğŸ“ å…³å¡2ç¬¬3ä¸ªå•è¯</button>
            <br>
            <button onclick="testProgressRestore(1)">ğŸ”„ æµ‹è¯•å…³å¡1æ¢å¤</button>
            <button onclick="testProgressRestore(2)">ğŸ”„ æµ‹è¯•å…³å¡2æ¢å¤</button>
            <button onclick="testProgressRestore(3)">ğŸ”„ æµ‹è¯•å…³å¡3æ¢å¤</button>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“ è¯¦ç»†æ—¥å¿—</h3>
            <div id="detailLog" class="status"></div>
            <button onclick="clearLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
            <button onclick="exportLog()" class="success">ğŸ“¤ å¯¼å‡ºæ—¥å¿—</button>
        </div>
    </div>

    <script>
        // æ¨¡æ‹Ÿå°ç¨‹åºç¯å¢ƒ
        const wx = {
            getStorageSync: (key) => {
                const value = localStorage.getItem(key);
                return value ? JSON.parse(value) : null;
            },
            setStorageSync: (key, data) => {
                localStorage.setItem(key, JSON.stringify(data));
            },
            removeStorageSync: (key) => {
                localStorage.removeItem(key);
            },
            showModal: (options) => {
                return new Promise((resolve) => {
                    const result = confirm(`${options.title}\n\n${options.content}`);
                    if (options.success) {
                        options.success({ confirm: result, cancel: !result });
                    }
                    resolve({ confirm: result, cancel: !result });
                });
            },
            showToast: (options) => {
                log(`Toast: ${options.title}`, 'info');
            }
        };

        // æ¨¡æ‹Ÿæ•°æ®ç®¡ç†å™¨
        class TestDataManager {
            constructor() {
                this.STORAGE_PREFIX = 'level_progress_';
            }

            /**
             * ä¿å­˜å…³å¡ä¸­é€”è¿›åº¦
             */
            saveLevelProgress(levelId, progressData) {
                try {
                    const progressKey = `${this.STORAGE_PREFIX}${levelId}`;
                    const saveData = {
                        levelId,
                        currentWordIndex: progressData.currentWordIndex,
                        stats: progressData.stats,
                        sessionId: progressData.sessionId,
                        savedAt: new Date().toISOString(),
                        mode: progressData.mode || 'learn'
                    };
                    
                    wx.setStorageSync(progressKey, saveData);
                    log(`ğŸ’¾ ä¿å­˜å…³å¡${levelId}ä¸­é€”è¿›åº¦: å•è¯ç´¢å¼•${progressData.currentWordIndex}`, 'success');
                    return true;
                } catch (error) {
                    log(`ä¿å­˜å…³å¡è¿›åº¦å¤±è´¥: ${error.message}`, 'error');
                    return false;
                }
            }

            /**
             * è·å–å…³å¡ä¸­é€”è¿›åº¦
             */
            getLevelProgress(levelId) {
                try {
                    const progressKey = `${this.STORAGE_PREFIX}${levelId}`;
                    const progressData = wx.getStorageSync(progressKey);
                    
                    if (progressData) {
                        log(`ğŸ“– æ‰¾åˆ°å…³å¡${levelId}çš„ä¸­é€”è¿›åº¦: å•è¯ç´¢å¼•${progressData.currentWordIndex}`, 'info');
                        return progressData;
                    }
                    
                    log(`ğŸ“– å…³å¡${levelId}æ²¡æœ‰ä¿å­˜çš„è¿›åº¦`, 'info');
                    return null;
                } catch (error) {
                    log(`è·å–å…³å¡è¿›åº¦å¤±è´¥: ${error.message}`, 'error');
                    return null;
                }
            }

            /**
             * æ¸…é™¤å…³å¡ä¸­é€”è¿›åº¦
             */
            clearLevelProgress(levelId) {
                try {
                    const progressKey = `${this.STORAGE_PREFIX}${levelId}`;
                    wx.removeStorageSync(progressKey);
                    log(`ğŸ—‘ï¸ æ¸…é™¤å…³å¡${levelId}çš„ä¸­é€”è¿›åº¦`, 'success');
                    return true;
                } catch (error) {
                    log(`æ¸…é™¤å…³å¡è¿›åº¦å¤±è´¥: ${error.message}`, 'error');
                    return false;
                }
            }

            /**
             * è·å–æ‰€æœ‰ä¿å­˜çš„è¿›åº¦
             */
            getAllSavedProgress() {
                const allProgress = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith(this.STORAGE_PREFIX)) {
                        const levelId = key.replace(this.STORAGE_PREFIX, '');
                        const progress = this.getLevelProgress(levelId);
                        if (progress) {
                            allProgress.push(progress);
                        }
                    }
                }
                return allProgress;
            }
        }

        const dataManager = new TestDataManager();

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            const logContainer = document.getElementById('detailLog');
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            document.getElementById('detailLog').innerHTML = '';
        }

        // å¯¼å‡ºæ—¥å¿—
        function exportLog() {
            const logContainer = document.getElementById('detailLog');
            const logs = Array.from(logContainer.children).map(entry => entry.textContent).join('\n');
            
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `progress-test-log-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // åˆ·æ–°çŠ¶æ€æ˜¾ç¤º
        function refreshStatus() {
            log('ğŸ”„ åˆ·æ–°çŠ¶æ€æ˜¾ç¤º...', 'info');
            
            const allProgress = dataManager.getAllSavedProgress();
            
            if (allProgress.length > 0) {
                const latest = allProgress[allProgress.length - 1];
                document.getElementById('currentLevel').textContent = latest.levelId;
                document.getElementById('currentWordIndex').textContent = latest.currentWordIndex;
                document.getElementById('statsDisplay').textContent = 
                    `${latest.stats.correct}/${latest.stats.total}`;
                document.getElementById('currentMode').textContent = latest.mode;
                
                log(`ğŸ“Š æ˜¾ç¤ºæœ€æ–°è¿›åº¦: å…³å¡${latest.levelId}, å•è¯${latest.currentWordIndex}`, 'success');
            } else {
                document.getElementById('currentLevel').textContent = '-';
                document.getElementById('currentWordIndex').textContent = '-';
                document.getElementById('statsDisplay').textContent = '-/-';
                document.getElementById('currentMode').textContent = '-';
                
                log('ğŸ“Š æ²¡æœ‰æ‰¾åˆ°ä»»ä½•ä¿å­˜çš„è¿›åº¦', 'info');
            }
            
            // æ˜¾ç¤ºæ‰€æœ‰ä¿å­˜çš„è¿›åº¦
            allProgress.forEach(progress => {
                log(`ğŸ“‹ å…³å¡${progress.levelId}: å•è¯${progress.currentWordIndex}, ç»Ÿè®¡${progress.stats.correct}/${progress.stats.total}, æ¨¡å¼${progress.mode}`, 'info');
            });
        }

        // æ¸…é™¤æ‰€æœ‰è¿›åº¦
        function clearAllProgress() {
            log('ğŸ—‘ï¸ å¼€å§‹æ¸…é™¤æ‰€æœ‰è¿›åº¦...', 'warning');
            
            const keys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('level_progress_')) {
                    keys.push(key);
                }
            }
            
            keys.forEach(key => {
                localStorage.removeItem(key);
            });
            
            log(`ğŸ—‘ï¸ å·²æ¸…é™¤${keys.length}ä¸ªè¿›åº¦è®°å½•`, 'success');
            refreshStatus();
        }

        // æ¨¡æ‹Ÿè¿›åº¦ä¿å­˜
        function simulateProgress(levelId, wordIndex) {
            log(`ğŸ® æ¨¡æ‹Ÿå…³å¡${levelId}è¿›åº¦ä¿å­˜: å•è¯ç´¢å¼•${wordIndex}`, 'info');
            
            const progressData = {
                currentWordIndex: wordIndex,
                stats: {
                    correct: Math.floor(wordIndex * 0.8),
                    total: wordIndex,
                    streak: Math.floor(Math.random() * 3)
                },
                sessionId: `test_session_${Date.now()}`,
                mode: 'learn'
            };
            
            const success = dataManager.saveLevelProgress(levelId, progressData);
            
            if (success) {
                log(`âœ… å…³å¡${levelId}è¿›åº¦ä¿å­˜æˆåŠŸ`, 'success');
                refreshStatus();
            } else {
                log(`âŒ å…³å¡${levelId}è¿›åº¦ä¿å­˜å¤±è´¥`, 'error');
            }
        }

        // æµ‹è¯•è¿›åº¦æ¢å¤
        async function testProgressRestore(levelId) {
            log(`ğŸ”„ æµ‹è¯•å…³å¡${levelId}è¿›åº¦æ¢å¤...`, 'info');
            
            const savedProgress = dataManager.getLevelProgress(levelId);
            
            if (savedProgress) {
                log(`âœ… æ‰¾åˆ°å…³å¡${levelId}çš„ä¿å­˜è¿›åº¦:`, 'success');
                log(`   - å•è¯ç´¢å¼•: ${savedProgress.currentWordIndex}`, 'info');
                log(`   - ç»Ÿè®¡æ•°æ®: ${savedProgress.stats.correct}/${savedProgress.stats.total}`, 'info');
                log(`   - å­¦ä¹ æ¨¡å¼: ${savedProgress.mode}`, 'info');
                log(`   - ä¿å­˜æ—¶é—´: ${savedProgress.savedAt}`, 'info');
                
                // æ¨¡æ‹Ÿç”¨æˆ·é€‰æ‹©æ¢å¤è¿›åº¦
                const result = await wx.showModal({
                    title: 'å‘ç°æœªå®Œæˆçš„è¿›åº¦',
                    content: `æ£€æµ‹åˆ°æ‚¨åœ¨ç¬¬${savedProgress.currentWordIndex + 1}ä¸ªå•è¯å¤„é€€å‡ºï¼Œæ˜¯å¦ç»§ç»­ä¹‹å‰çš„è¿›åº¦ï¼Ÿ`
                });
                
                if (result.confirm) {
                    log(`ğŸ”„ ç”¨æˆ·é€‰æ‹©æ¢å¤å…³å¡${levelId}çš„è¿›åº¦`, 'success');
                    log(`ğŸ“š æ¨¡æ‹ŸåŠ è½½ç¬¬${savedProgress.currentWordIndex + 1}ä¸ªå•è¯`, 'success');
                } else {
                    log(`ğŸ”„ ç”¨æˆ·é€‰æ‹©é‡æ–°å¼€å§‹å…³å¡${levelId}`, 'info');
                    dataManager.clearLevelProgress(levelId);
                    refreshStatus();
                }
            } else {
                log(`âŒ å…³å¡${levelId}æ²¡æœ‰ä¿å­˜çš„è¿›åº¦`, 'warning');
            }
        }

        // åœºæ™¯æµ‹è¯•
        async function testScenario1() {
            log('ğŸ¯ å¼€å§‹åœºæ™¯1æµ‹è¯•ï¼šæ­£å¸¸è¿›åº¦ä¿å­˜å’Œæ¢å¤', 'info');
            
            // æ­¥éª¤1ï¼šæ¨¡æ‹Ÿå­¦ä¹ åˆ°ç¬¬5ä¸ªå•è¯
            simulateProgress(1, 4);
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // æ­¥éª¤2ï¼šæµ‹è¯•è¿›åº¦æ¢å¤
            await testProgressRestore(1);
            
            log('ğŸ¯ åœºæ™¯1æµ‹è¯•å®Œæˆ', 'success');
        }

        async function testScenario2() {
            log('ğŸ”„ å¼€å§‹åœºæ™¯2æµ‹è¯•ï¼šç”¨æˆ·é€‰æ‹©é‡æ–°å¼€å§‹', 'warning');
            
            // æ­¥éª¤1ï¼šæ¨¡æ‹Ÿå­¦ä¹ åˆ°ç¬¬3ä¸ªå•è¯
            simulateProgress(2, 2);
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // æ­¥éª¤2ï¼šæµ‹è¯•è¿›åº¦æ¢å¤ï¼ˆç”¨æˆ·ä¼šé€‰æ‹©é‡æ–°å¼€å§‹ï¼‰
            log('ğŸ’¡ æç¤ºï¼šåœ¨å¼¹çª—ä¸­é€‰æ‹©"å–æ¶ˆ"æ¥æ¨¡æ‹Ÿé‡æ–°å¼€å§‹', 'warning');
            await testProgressRestore(2);
            
            log('ğŸ”„ åœºæ™¯2æµ‹è¯•å®Œæˆ', 'success');
        }

        async function testScenario3() {
            log('ğŸ® å¼€å§‹åœºæ™¯3æµ‹è¯•ï¼šå¤šå…³å¡è¿›åº¦ç®¡ç†', 'info');
            
            // åœ¨å¤šä¸ªå…³å¡ä¸­ä¿å­˜è¿›åº¦
            simulateProgress(1, 3);
            await new Promise(resolve => setTimeout(resolve, 200));
            simulateProgress(2, 5);
            await new Promise(resolve => setTimeout(resolve, 200));
            simulateProgress(3, 1);
            await new Promise(resolve => setTimeout(resolve, 200));
            
            log('ğŸ“Š å¤šå…³å¡è¿›åº¦å·²ä¿å­˜ï¼Œç°åœ¨æµ‹è¯•æ¢å¤...', 'info');
            
            // æµ‹è¯•ä¸åŒå…³å¡çš„è¿›åº¦æ¢å¤
            await testProgressRestore(1);
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testProgressRestore(2);
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testProgressRestore(3);
            
            log('ğŸ® åœºæ™¯3æµ‹è¯•å®Œæˆ', 'success');
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            log('ğŸš€ å…³å¡è¿›åº¦ä¿å­˜æµ‹è¯•é¡µé¢å·²åŠ è½½ï¼ˆä¿®å¤ç‰ˆï¼‰', 'success');
            log('ğŸ”§ ä¿®å¤å†…å®¹ï¼šåœ¨restoreProgressä¸­æ·»åŠ loadCurrentWord()è°ƒç”¨', 'info');
            refreshStatus();
        };
    </script>
</body>
</html>